<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FrontDesk // Boardroom</title>
    <link href="./lib/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=2" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        padding-bottom: 50px;
      }
      .admin-header {
        border-bottom: 1px solid var(--theme-bg-mid);
        padding-bottom: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: rgba(22, 22, 30, 0.6) !important;
        border: 1px dashed var(--theme-bg-mid) !important;
        transition: all 0.2s ease;
      }
      .stat-card:hover {
        border-color: var(--theme-purple) !important;
        box-shadow: 0 0 15px rgba(187, 154, 247, 0.1);
      }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--theme-fg);
        text-shadow: 0 0 10px rgba(192, 202, 245, 0.3);
      }
      .stat-label {
        color: var(--theme-comment);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.75rem;
      }
      #financialChart {
        max-height: 500px;
      }
      .chart-container {
        position: relative;
        height: 500px;
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container-fluid p-4">
      <div
        class="d-flex justify-content-between align-items-center admin-header"
      >
        <div class="d-flex align-items-center gap-3">
          <h3 class="mb-0 text-purple" style="letter-spacing: 2px">
            <i class="bi bi-graph-up me-2"></i>BOARDROOM
          </h3>
          <span class="badge bg-secondary text-muted" style="font-size: 0.7rem">
            FINANCIAL ANALYTICS
          </span>
        </div>
        <div>
          <a href="monitor.html" class="btn btn-outline-info btn-sm me-2">
            <i class="bi bi-eye"></i> Monitor
          </a>
          <a href="analytics.html" class="btn btn-primary btn-sm me-2">
            <i class="bi bi-bar-chart"></i> Analytics
          </a>
          <button class="btn btn-outline-info btn-sm me-2" @click="fetchData">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <a
            href="javascript:void(0)"
            onclick="logout()"
            class="btn btn-sm btn-outline-secondary"
          >
            LOGOUT <i class="bi bi-box-arrow-right"></i>
          </a>
        </div>
      </div>

      <div v-if="loading" class="text-center py-5">
        <div
          class="spinner-border text-purple mb-3"
          role="status"
          style="width: 3rem; height: 3rem"
        ></div>
        <h5>Decrypting Financial Ledger...</h5>
      </div>

      <div v-else-if="data.length === 0" class="text-center py-5 text-muted">
        <i class="bi bi-graph-down display-1 mb-3 opacity-25"></i>
        <h4>No Financial Data Yet</h4>
        <p class="lead">
          Revenue and costs will appear here once transactions occur.
        </p>
      </div>

      <div v-else>
        <!-- Summary Cards -->
        <div class="row mb-5">
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-success">
                ${{ totalRevenue.toFixed(2) }}
              </div>
              <div class="stat-label">Total Revenue</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-danger">
                ${{ totalCost.toFixed(2) }}
              </div>
              <div class="stat-label">Total Cost</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-info">
                ${{ totalProfit.toFixed(2) }}
              </div>
              <div class="stat-label">Net Profit</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-warning">
                {{ margin.toFixed(1) }}%
              </div>
              <div class="stat-label">Profit Margin</div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="card shadow-lg">
          <div class="card-header bg-transparent border-0">
            <h5 class="mb-0 text-white">
              <i class="bi bi-trending-up me-2"></i>30-Day P&L Trend
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="chart-container">
              <canvas id="financialChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./lib/js/vue.global.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script>
      // Global logout
      window.logout = function () {
        localStorage.removeItem("authToken");
        window.location.href = "/static/index.html";
      };

      const { createApp, ref, computed, onMounted, watch } = Vue;

      createApp({
        setup() {
          const data = ref([]);
          const loading = ref(true);
          const token = localStorage.getItem("authToken");
          let chart = null;

          const totalRevenue = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_revenue || 0), 0),
          );
          const totalCost = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_cost || 0), 0),
          );
          const totalProfit = computed(() =>
            data.value.reduce((sum, d) => sum + (d.gross_profit || 0), 0),
          );
          const margin = computed(() =>
            totalRevenue.value > 0
              ? (totalProfit.value / totalRevenue.value) * 100
              : 0,
          );

          const fetchData = async () => {
            if (!token) {
              window.location.href = "/static/index.html";
              return;
            }
            try {
              loading.value = true;
              const res = await axios.get("/api/admin/analytics", {
                headers: { Authorization: `Bearer ${token}` },
              });
              data.value = res.data || [];
              renderChart();
            } catch (e) {
              console.error(e);
              if (e.response?.status === 403) {
                alert("Access Denied. Logging out.");
                logout();
              } else {
                alert("Failed to fetch analytics data.");
              }
            } finally {
              loading.value = false;
            }
          };

          const renderChart = () => {
            const ctx = document
              .getElementById("financialChart")
              ?.getContext("2d");
            if (!ctx || data.value.length === 0) return;

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
              data: {
                labels: data.value.map((d) => d.date),
                datasets: [
                  {
                    label: "Revenue ($)",
                    data: data.value.map((d) => d.total_revenue || 0),
                    backgroundColor: "rgba(34, 197, 94, 0.8)",
                    borderColor: "rgba(34, 197, 94, 1)",
                    borderWidth: 2,
                    type: "bar",
                    order: 1,
                  },
                  {
                    label: "Cost ($)",
                    data: data.value.map((d) => d.total_cost || 0),
                    borderColor: "rgba(239, 68, 68, 1)",
                    backgroundColor: "rgba(239, 68, 68, 0.1)",
                    fill: false,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 2,
                  },
                  {
                    label: "Profit ($)",
                    data: data.value.map((d) => d.gross_profit || 0),
                    borderColor: "rgba(59, 130, 246, 1)",
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    fill: true,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 3,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: "rgba(255,255,255,0.1)" },
                    ticks: { color: "white" },
                  },
                  x: {
                    grid: { color: "rgba(255,255,255,0.05)" },
                    ticks: { color: "white", maxRotation: 45 },
                  },
                },
                plugins: {
                  legend: { labels: { color: "white", usePointStyle: true } },
                  tooltip: {
                    backgroundColor: "rgba(0,0,0,0.9)",
                    titleColor: "white",
                    bodyColor: "white",
                    callbacks: {
                      label: (ctx) => `$${ctx.parsed.y?.toFixed(2)}`,
                    },
                  },
                },
                interaction: { intersect: false, mode: "index" },
              },
            });
          };

          onMounted(() => {
            fetchData();
          });

          watch(data, renderChart);

          return {
            data,
            loading,
            totalRevenue,
            totalCost,
            totalProfit,
            margin,
            fetchData,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
