<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FrontDesk // Boardroom</title>
    <link href="./lib/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=2" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        padding-bottom: 50px;
      }
      .stat-card {
        background: var(--theme-bg-transparent) !important;
        border: 1px solid var(--theme-bg-mid) !important;
      }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--theme-fg);
      }
      .stat-label {
        color: var(--theme-muted);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.75rem;
      }
      #financialChart {
        max-height: 500px;
      }
      .chart-container {
        position: relative;
        height: 500px;
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container-fluid p-4">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
          <span class="navbar-brand mb-0">
            <i class="bi bi-graph-up me-2"></i>ANALYTICS
          </span>
          <div class="navbar-nav ms-auto d-flex align-items-center gap-2">
            <a href="monitor.html" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-eye me-1"></i>MONITOR
            </a>
            <button class="btn btn-sm btn-outline-secondary" @click="openSettings">
              <i class="bi bi-wallet2"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" @click="fetchData">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <a
              href="javascript:void(0)"
              onclick="logout()"
              class="btn btn-sm btn-outline-secondary"
            >
              <i class="bi bi-box-arrow-right"></i>
            </a>
          </div>
        </div>
      </nav>

      <div v-if="loading" class="text-center py-5">
        <div
          class="spinner-border text-purple mb-3"
          role="status"
          style="width: 3rem; height: 3rem"
        ></div>
        <h5>Decrypting Financial Ledger...</h5>
      </div>

      <div v-else-if="data.length === 0" class="text-center py-5 text-muted">
        <i class="bi bi-graph-down display-1 mb-3 opacity-25"></i>
        <h4>No Financial Data Yet</h4>
        <p class="lead">
          Revenue and costs will appear here once transactions occur.
        </p>
      </div>

      <div v-else>
        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card stat-card p-3">
              <div class="stat-label">REVENUE</div>
              <div class="stat-value">${{ totalRevenue.toFixed(2) }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-3">
              <div class="stat-label">COST</div>
              <div class="stat-value">${{ totalCost.toFixed(2) }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-3">
              <div class="stat-label">PROFIT</div>
              <div class="stat-value">${{ totalProfit.toFixed(2) }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-3">
              <div class="stat-label">MARGIN</div>
              <div class="stat-value">{{ margin.toFixed(1) }}%</div>
            </div>
          </div>
        </div>

        <!-- Cost Breakdown by Service -->
        <div class="card mb-4">
          <div class="card-header">
            <i class="bi bi-pie-chart me-2"></i>COST BREAKDOWN BY SERVICE
          </div>
          <div class="card-body">
            <div v-if="Object.keys(costByService).length === 0" class="text-muted text-center py-4">
              No service cost data available
            </div>
            <div v-else class="row g-3">
              <div v-for="(data, service) in costByService" :key="service" class="col-md-3">
                <div class="p-3 border border-secondary border-opacity-25 rounded" style="background: rgba(255,255,255,0.02)">
                  <div class="text-muted small mb-1 text-uppercase">{{ service.replace('_', ' ') }}</div>
                  <div class="h5 mb-0 text-fg">${{ data.cost.toFixed(2) }}</div>
                  <div class="text-muted small">{{ data.quantity.toLocaleString() }} units</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Two Column Layout: Top Calls + Client Costs -->
        <div class="row g-3 mb-4">
          <!-- Top Expensive Calls -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">
                <i class="bi bi-lightning me-2"></i>TOP EXPENSIVE CALLS
              </div>
              <div class="card-body p-0">
                <div v-if="topCalls.length === 0" class="text-muted text-center py-4">
                  No call data available
                </div>
                <div v-else class="table-responsive">
                  <table class="table table-custom table-no-hover mb-0">
                    <thead>
                      <tr>
                        <th>Client</th>
                        <th>Date</th>
                        <th class="text-end">Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="call in topCalls" :key="call.conversation_id">
                        <td class="text-purple">{{ call.client_name }}</td>
                        <td class="text-muted small">{{ new Date(call.created_at).toLocaleDateString() }}</td>
                        <td class="text-end text-fg fw-bold">${{ call.total_cost }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Cost Ranking -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">
                <i class="bi bi-people me-2"></i>CLIENT COST RANKING
              </div>
              <div class="card-body p-0">
                <div v-if="costByClient.length === 0" class="text-muted text-center py-4">
                  No client cost data available
                </div>
                <div v-else class="table-responsive">
                  <table class="table table-custom table-no-hover mb-0">
                    <thead>
                      <tr>
                        <th>Client</th>
                        <th class="text-end">Total Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="client in costByClient.slice(0, 10)" :key="client.client_id">
                        <td class="text-purple">{{ client.client_name }}</td>
                        <td class="text-end text-fg fw-bold">${{ client.total_cost }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="card">
          <div class="card-header">
            <i class="bi bi-bar-chart me-2"></i>30-DAY TREND
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="financialChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS MODAL -->
      <div
        class="modal fade"
        id="settingsModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-gear me-2"></i>SETTINGS
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul
                class="nav nav-tabs mb-3 border-secondary border-opacity-25"
                id="settingsTabs"
                role="tablist"
              >
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="wallet-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#wallet"
                    type="button"
                    role="tab"
                  >
                    Service Wallet
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="rates-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#rates"
                    type="button"
                    role="tab"
                  >
                    Unit Costs
                  </button>
                </li>
              </ul>
              <div class="tab-content" id="settingsTabsContent">
                <!-- Wallet Tab -->
                <div
                  class="tab-pane fade show active"
                  id="wallet"
                  role="tabpanel"
                >
                  <div class="row g-3">
                    <!-- Twilio -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-transparent border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >TWILIO BALANCE</label
                        >
                        <div class="h4 mb-0 text-fg font-monospace">
                          {{ formatMoney(wallet.twilio && wallet.twilio.balance)
                          }}
                        </div>
                        <div class="small text-muted">
                          {{ (wallet.twilio && wallet.twilio.currency) || 'USD'
                          }}
                        </div>
                      </div>
                    </div>
                    <!-- OpenRouter -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-transparent border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >OPENROUTER</label
                        >
                        <div class="h4 mb-0 text-fg font-monospace">
                          {{ getOpenRouterCredits(wallet) }}
                        </div>
                        <div class="small text-muted">Credits Available</div>
                      </div>
                    </div>
                    <!-- Deepgram -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-transparent border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >DEEPGRAM</label
                        >
                        <div class="h4 mb-0 text-fg font-monospace">
                          {{ getDeepgramBalance(wallet) }}
                        </div>
                        <div class="small text-muted">Remaining Balance</div>
                      </div>
                    </div>
                    <!-- ElevenLabs -->
                    <div class="col-12 mt-4">
                      <label class="text-muted small mb-2"
                        >ELEVENLABS USAGE</label
                      >
                      <div
                        class="progress"
                        style="height: 25px; background: #333"
                      >
                        <div
                          class="progress-bar bg-warning"
                          role="progressbar"
                          :style="{ width: (100 - (((wallet.elevenlabs && wallet.elevenlabs.percent) || 0) * 100)) + '%' }"
                        >
                          {{ formatElevenLabsUsage((wallet.elevenlabs &&
                          wallet.elevenlabs.used), (wallet.elevenlabs &&
                          wallet.elevenlabs.limit)) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rates Tab -->
                <div class="tab-pane fade" id="rates" role="tabpanel">
                  <p class="text-muted small mb-4">
                    <i class="bi bi-info-circle me-1"></i> These rates determine
                    the deductions from client balances per minute of usage.
                  </p>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-fg"
                      >Twilio Voice (Per Min)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-transparent border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.twilio_cost_per_min"
                          step="0.0001"
                          class="form-control bg-transparent text-fg border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('twilio_cost_per_min')"
                      >
                        Save
                      </button>
                    </div>
                  </div>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-fg"
                      >STT (Deepgram) (Per Min)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-transparent border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.stt_cost_per_min"
                          step="0.0001"
                          class="form-control bg-transparent text-fg border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('stt_cost_per_min')"
                      >
                        Save
                      </button>
                    </div>
                  </div>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-fg"
                      >TTS (ElevenLabs) (Per Char)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-transparent border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.tts_cost_per_char"
                          step="0.00001"
                          class="form-control bg-transparent text-fg border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('tts_cost_per_char')"
                      >
                        Save
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./lib/js/vue.global.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script>
      // Global logout
      window.logout = function () {
        localStorage.removeItem("authToken");
        window.location.href = "/static/index.html";
      };

      const { createApp, ref, computed, onMounted, watch } = Vue;

      createApp({
        setup() {
          const data = ref([]);
          const loading = ref(true);
          const token = localStorage.getItem("authToken");
          let chart = null;

          // New detailed analytics data
          const costByService = ref({});
          const costByClient = ref([]);
          const topCalls = ref([]);

          // Theme State
          const themes = ref([]);
          const currentTheme = ref(localStorage.getItem("currentTheme") || "tokyo-night-default");

          const loadThemes = () => {
            const defaultThemes = [
              {
                key: "tokyo-night-default",
                name: "Tokyo Night Default",
                data: {
                  background: "#1a1b26",
                  foreground: "#c0caf5",
                  cursor: "#7aa2f7",
                  selection: "#283457",
                  ansi_colors: {
                    black: "#15161E",
                    red: "#F77693",
                    green: "#9ECE6A",
                    yellow: "#E0AF68",
                    blue: "#7AA2F7",
                    magenta: "#BB9AF7",
                    cyan: "#7DCFFF",
                    white: "#A9B1D6",
                    bright_black: "#414868",
                    bright_red: "#F77693",
                    bright_green: "#9ECE6A",
                    bright_yellow: "#E0AF68",
                    bright_blue: "#7AA2F7",
                    bright_magenta: "#BB9AF7",
                    bright_cyan: "#7DCFFF",
                    bright_white: "#C0CAF5",
                  },
                },
              },
              {
                key: "tokyo-night-day",
                name: "Tokyo Night Day",
                data: {
                  background: "#E2E2E7",
                  foreground: "#3760BF",
                  cursor: "#2E7DE9",
                  selection: "#B7C1E3",
                  ansi_colors: {
                    black: "#B3B5B9",
                    red: "#F52A65",
                    green: "#587539",
                    yellow: "#8C6C3E",
                    blue: "#2E7DE9",
                    magenta: "#9854F1",
                    cyan: "#007197",
                    white: "#6172B0",
                    bright_black: "#A1A6C5",
                    bright_red: "#F52A65",
                    bright_green: "#587539",
                    bright_yellow: "#8C6C3E",
                    bright_blue: "#2E7DE9",
                    bright_magenta: "#9854F1",
                    bright_cyan: "#007197",
                    bright_white: "#3760BF",
                  },
                },
              },
              {
                key: "iceberg-dark",
                name: "Iceberg Dark",
                data: {
                  background: "#161821",
                  foreground: "#C7C9D1",
                  cursor: "#89BFC3",
                  selection: "#272C41",
                  ansi_colors: {
                    black: "#1E212B",
                    red: "#E2777A",
                    green: "#B6BA89",
                    yellow: "#E2A677",
                    blue: "#83A5AD",
                    magenta: "#9F91A8",
                    cyan: "#89BFC3",
                    white: "#C7C9D1",
                    bright_black: "#6B7089",
                    bright_red: "#E98A8A",
                    bright_green: "#C0CAF5",
                    bright_yellow: "#E9B18A",
                    bright_blue: "#91A9C6",
                    bright_magenta: "#AD9FAD",
                    bright_cyan: "#95C4CC",
                    bright_white: "#D2D4DD",
                  },
                },
              },
              {
                key: "iceberg-light",
                name: "Iceberg Light",
                data: {
                  background: "#E8E9EC",
                  foreground: "#33374C",
                  cursor: "#3F83A6",
                  selection: "#CAD0D7",
                  ansi_colors: {
                    black: "#DCDFE7",
                    red: "#CC517A",
                    green: "#668E3D",
                    yellow: "#C57339",
                    blue: "#2D539E",
                    magenta: "#7759B5",
                    cyan: "#3F83A6",
                    white: "#33374C",
                    bright_black: "#838A96",
                    bright_red: "#CC3768",
                    bright_green: "#598030",
                    bright_yellow: "#B6662D",
                    bright_blue: "#22478E",
                    bright_magenta: "#6845AD",
                    bright_cyan: "#327698",
                    bright_white: "#3D425E",
                  },
                },
              },
            ];
            themes.value = defaultThemes;
            applyTheme(currentTheme.value);
          };

          const getBrightness = (hexColor) => {
             const color = hexColor.replace("#", "");
             const r = parseInt(color.substr(0, 2), 16);
             const g = parseInt(color.substr(2, 2), 16);
             const b = parseInt(color.substr(4, 2), 16);
             return (r * 299 + g * 587 + b * 114) / 1000;
          };

          const applyTheme = (themeKey) => {
            const theme = themes.value.find((t) => t.key === themeKey);
            if (!theme) return;
            const root = document.documentElement;
            const themeData = theme.data;
            root.style.setProperty("--theme-bg", themeData.background || "#1a1b26");
            root.style.setProperty("--theme-fg", themeData.foreground || "#c0caf5");
            root.style.setProperty("--theme-cursor", themeData.cursor || "#7aa2f7");
            root.style.setProperty("--theme-selection", themeData.selection || "#283457");

            const bgBrightness = getBrightness(themeData.background || "#1a1b26");
            const isLightTheme = bgBrightness > 128;
            const mutedColor = isLightTheme ? "#555" : "#888";
            root.style.setProperty("--theme-muted", mutedColor);

            const ansiColors = themeData.ansi_colors;
            if (ansiColors) {
               root.style.setProperty("--theme-bg-transparent", ansiColors.black || "#16161e");
               root.style.setProperty("--theme-bg-mid", ansiColors.bright_black || "#2a2a37");
               root.style.setProperty("--theme-card-bg", ansiColors.black || "#16161e");
               root.style.setProperty("--theme-blue", ansiColors.blue || "#7dcfff");
               root.style.setProperty("--theme-purple", ansiColors.magenta || "#bb9af7");
               root.style.setProperty("--theme-green", ansiColors.green || "#9ece6a");
               root.style.setProperty("--theme-yellow", ansiColors.yellow || "#e0af68");
               root.style.setProperty("--theme-orange", ansiColors.yellow || "#e0af68");
               root.style.setProperty("--theme-red", ansiColors.red || "#f7768e");
               root.style.setProperty("--theme-cyan", ansiColors.cyan || "#7dcfff");
               root.style.setProperty("--theme-comment", ansiColors.bright_black || "#565f89");
               root.style.setProperty("--theme-logo-white", ansiColors.bright_white || "#ffffff");

               root.style.setProperty("--theme-black-bright", ansiColors.bright_black || "#414868");
               root.style.setProperty("--theme-red-bright", ansiColors.bright_red || "#f7768e");
               root.style.setProperty("--theme-green-bright", ansiColors.bright_green || "#9ece6a");
               root.style.setProperty("--theme-yellow-bright", ansiColors.bright_yellow || "#e0af68");
               root.style.setProperty("--theme-blue-bright", ansiColors.bright_blue || "#7aa2f7");
               root.style.setProperty("--theme-magenta-bright", ansiColors.bright_magenta || "#bb9af7");
               root.style.setProperty("--theme-cyan-bright", ansiColors.bright_cyan || "#7dcfff");
               root.style.setProperty("--theme-white-bright", ansiColors.bright_white || "#c0caf5");
            }

            root.style.setProperty("--theme-border-active", "2px");
            root.style.setProperty("--theme-tools-bg", "transparent");
            root.style.setProperty("--theme-tools-border", "var(--theme-bg-mid)");
            root.style.setProperty("--theme-tools-label", "var(--theme-purple)");

            if (isLightTheme) {
               root.style.setProperty("--theme-bg-transparent", "#ffffff");
               root.style.setProperty("--theme-card-bg", "#ffffff");
               root.style.setProperty("--theme-bg-mid", "#b4b9c9");
               root.style.setProperty("--theme-table-stripe", "rgba(0, 0, 0, 0.03)");
               root.style.setProperty("--theme-table-hover", "rgba(46, 125, 233, 0.1)");
               root.style.setProperty("--theme-btn-glow", "rgba(0, 0, 0, 0.1)");
               root.style.setProperty("--theme-text-glow", "none");
               root.style.setProperty("--theme-gradient-1", "rgba(55, 96, 191, 0.15)");
               root.style.setProperty("--theme-gradient-2", "rgba(120, 117, 213, 0.15)");
               root.style.setProperty("--theme-border-active", "3px");
               root.style.setProperty("--theme-tools-bg", "rgba(158, 206, 106, 0.15)");
               root.style.setProperty("--theme-tools-border", "rgba(88, 117, 57, 0.5)");
               root.style.setProperty("--theme-tools-label", "#3c5220");
            } else {
               root.style.setProperty("--theme-gradient-1", "rgba(122, 162, 247, 0.08)");
               root.style.setProperty("--theme-gradient-2", "rgba(187, 154, 247, 0.08)");
            }

            currentTheme.value = themeKey;
            localStorage.setItem("currentTheme", themeKey);
            
            // Re-render chart if it exists to pick up new colors
            if (chart) renderChart();
          };

          // Settings State
          const wallet = ref({});
          const rates = ref({});
          const settingsModal = ref(null);

          const fetchSettings = async () => {
            try {
              const [balRes, ratesRes] = await Promise.all([
                axios.get("/api/admin/balances", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
                axios.get("/api/admin/settings", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
              ]);
              wallet.value = balRes.data;
              rates.value = ratesRes.data;
            } catch (e) {
              console.error("Failed to fetch settings:", e);
            }
          };

          const saveRate = async (key) => {
            try {
              await axios.post(
                "/api/admin/settings",
                {
                  key: key,
                  value: String(rates.value[key]),
                },
                { headers: { Authorization: `Bearer ${token}` } },
              );
              alert("Rate updated successfully.");
            } catch (e) {
              console.error("Failed to save rate:", e);
              alert("Failed to update rate.");
            }
          };

          const openSettings = async () => {
            if (!settingsModal.value) {
              settingsModal.value = new bootstrap.Modal(
                document.getElementById("settingsModal"),
              );
            }
            await fetchSettings();
            settingsModal.value.show();
          };

          const totalRevenue = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_revenue || 0), 0),
          );
          const totalCost = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_cost || 0), 0),
          );
          const totalProfit = computed(() =>
            data.value.reduce((sum, d) => sum + (d.gross_profit || 0), 0),
          );
          const margin = computed(() =>
            totalRevenue.value > 0
              ? (totalProfit.value / totalRevenue.value) * 100
              : 0,
          );

          const fetchData = async () => {
            if (!token) {
              window.location.href = "/static/index.html";
              return;
            }
            try {
              loading.value = true;

              // Fetch all analytics data in parallel
              const [mainRes, serviceRes, clientRes, callsRes] = await Promise.all([
                axios.get("/api/admin/analytics", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
                axios.get("/api/admin/analytics/by-service", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
                axios.get("/api/admin/analytics/by-client", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
                axios.get("/api/admin/analytics/top-calls", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
              ]);

              data.value = mainRes.data || [];
              costByService.value = serviceRes.data || {};
              costByClient.value = clientRes.data || [];
              topCalls.value = callsRes.data || [];

              renderChart();
            } catch (e) {
              console.error(e);
              if (e.response?.status === 403) {
                alert("Access Denied. Logging out.");
                logout();
              } else {
                alert("Failed to fetch analytics data.");
              }
            } finally {
              loading.value = false;
            }
          };

          const renderChart = () => {
            const ctx = document
              .getElementById("financialChart")
              ?.getContext("2d");
            if (!ctx || data.value.length === 0) return;

            if (chart) chart.destroy();

            // Get Theme Colors
            const style = getComputedStyle(document.documentElement);
            const colorFg = style.getPropertyValue('--theme-fg').trim() || 'white';
            const colorBgMid = style.getPropertyValue('--theme-bg-mid').trim() || 'rgba(255,255,255,0.1)';

            chart = new Chart(ctx, {
              data: {
                labels: data.value.map((d) => d.date),
                datasets: [
                  {
                    label: "Revenue ($)",
                    data: data.value.map((d) => d.total_revenue || 0),
                    backgroundColor: "rgba(34, 197, 94, 0.8)",
                    borderColor: "rgba(34, 197, 94, 1)",
                    borderWidth: 2,
                    type: "bar",
                    order: 1,
                  },
                  {
                    label: "Cost ($)",
                    data: data.value.map((d) => d.total_cost || 0),
                    borderColor: "rgba(239, 68, 68, 1)",
                    backgroundColor: "rgba(239, 68, 68, 0.1)",
                    fill: false,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 2,
                  },
                  {
                    label: "Profit ($)",
                    data: data.value.map((d) => d.gross_profit || 0),
                    borderColor: "rgba(59, 130, 246, 1)",
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    fill: true,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 3,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: colorBgMid },
                    ticks: { color: colorFg },
                  },
                  x: {
                    grid: { color: colorBgMid },
                    ticks: { color: colorFg, maxRotation: 45 },
                  },
                },
                plugins: {
                  legend: { labels: { color: colorFg, usePointStyle: true } },
                  tooltip: {
                    backgroundColor: "rgba(0,0,0,0.9)",
                    titleColor: "white",
                    bodyColor: "white",
                    callbacks: {
                      label: (ctx) => `$${ctx.parsed.y?.toFixed(2)}`,
                    },
                  },
                },
                interaction: { intersect: false, mode: "index" },
              },
            });
          };

          onMounted(() => {
            loadThemes();
            fetchData();
          });

          watch(data, renderChart);

          return {
            data,
            loading,
            themes,
            currentTheme,
            applyTheme,
            totalRevenue,
            totalCost,
            totalProfit,
            margin,
            fetchData,
            // Detailed analytics
            costByService,
            costByClient,
            topCalls,
            // Settings
            wallet,
            rates,
            openSettings,
            saveRate,
            formatMoney: (val, currency = "USD") => {
              if (val === undefined || val === null) return "---";
              return "$" + parseFloat(val).toFixed(2);
            },
            formatElevenLabsUsage: (used, limit) => {
              if (!used || !limit) return "0 / 0 Chars";
              return (
                (used / 1000).toFixed(1) +
                "k / " +
                (limit / 1000).toFixed(0) +
                "k Chars"
              );
            },
            getDeepgramBalance: (w) => {
              if (
                w &&
                w.deepgram &&
                w.deepgram.balances &&
                w.deepgram.balances[0] &&
                w.deepgram.balances[0].amount
              ) {
                return (
                  "$" + parseFloat(w.deepgram.balances[0].amount).toFixed(2)
                );
              }
              return "---";
            },
            getOpenRouterCredits: (w) => {
              if (
                w &&
                w.openrouter &&
                w.openrouter.data &&
                w.openrouter.data.total_credits
              ) {
                const credits =
                  parseFloat(w.openrouter.data.total_credits) || 0;
                const usage = parseFloat(w.openrouter.data.total_usage) || 0;
                return "$" + (credits - usage).toFixed(2);
              }
              return "---";
            },
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
