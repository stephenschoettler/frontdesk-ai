<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FrontDesk // Boardroom</title>
    <link href="./lib/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=2" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        padding-bottom: 50px;
      }
      .admin-header {
        border-bottom: 1px solid var(--theme-bg-mid);
        padding-bottom: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: rgba(22, 22, 30, 0.6) !important;
        border: 1px dashed var(--theme-bg-mid) !important;
        transition: all 0.2s ease;
      }
      .stat-card:hover {
        border-color: var(--theme-purple) !important;
        box-shadow: 0 0 15px rgba(187, 154, 247, 0.1);
      }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--theme-fg);
        text-shadow: 0 0 10px rgba(192, 202, 245, 0.3);
      }
      .stat-label {
        color: var(--theme-comment);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.75rem;
      }
      #financialChart {
        max-height: 500px;
      }
      .chart-container {
        position: relative;
        height: 500px;
        margin-top: 30px;
      }

      /* --- FIX FOR VUE MANUAL MODALS (No Backdrop Element) --- */
      /* Since there is no .modal-backdrop div, we dim the .modal container itself */
      #app .modal.show {
        background-color: rgba(0, 0, 0, 0.6) !important; /* The Dim */
        -webkit-backdrop-filter: blur(8px) !important; /* The Blur */
        backdrop-filter: blur(8px) !important;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container-fluid p-4">
      <div
        class="d-flex justify-content-between align-items-center admin-header"
      >
        <div class="d-flex align-items-center gap-3">
          <h3 class="mb-0 text-purple" style="letter-spacing: 2px">
            <i class="bi bi-graph-up me-2"></i>BOARDROOM
          </h3>
          <span class="badge bg-secondary text-muted" style="font-size: 0.7rem">
            FINANCIAL ANALYTICS
          </span>
        </div>
        <div>
          <a href="monitor.html" class="btn btn-outline-info btn-sm me-2">
            <i class="bi bi-eye"></i> Monitor
          </a>
          <a href="analytics.html" class="btn btn-primary btn-sm me-2">
            <i class="bi bi-bar-chart"></i> Analytics
          </a>
          <button
            class="btn btn-sm btn-outline-warning me-2"
            @click="openSettings"
          >
            <i class="bi bi-wallet2"></i> SETTINGS
          </button>
          <button class="btn btn-outline-info btn-sm me-2" @click="fetchData">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <a
            href="javascript:void(0)"
            onclick="logout()"
            class="btn btn-sm btn-outline-secondary"
          >
            LOGOUT <i class="bi bi-box-arrow-right"></i>
          </a>
        </div>
      </div>

      <div v-if="loading" class="text-center py-5">
        <div
          class="spinner-border text-purple mb-3"
          role="status"
          style="width: 3rem; height: 3rem"
        ></div>
        <h5>Decrypting Financial Ledger...</h5>
      </div>

      <div v-else-if="data.length === 0" class="text-center py-5 text-muted">
        <i class="bi bi-graph-down display-1 mb-3 opacity-25"></i>
        <h4>No Financial Data Yet</h4>
        <p class="lead">
          Revenue and costs will appear here once transactions occur.
        </p>
      </div>

      <div v-else>
        <!-- Summary Cards -->
        <div class="row mb-5">
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-success">
                ${{ totalRevenue.toFixed(2) }}
              </div>
              <div class="stat-label">Total Revenue</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-danger">
                ${{ totalCost.toFixed(2) }}
              </div>
              <div class="stat-label">Total Cost</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-info">
                ${{ totalProfit.toFixed(2) }}
              </div>
              <div class="stat-label">Net Profit</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card p-4 text-center">
              <div class="stat-value text-warning">
                {{ margin.toFixed(1) }}%
              </div>
              <div class="stat-label">Profit Margin</div>
            </div>
          </div>
        </div>

        <!-- Chart -->
        <div class="card shadow-lg">
          <div class="card-header bg-transparent border-0">
            <h5 class="mb-0 text-white">
              <i class="bi bi-trending-up me-2"></i>30-Day P&L Trend
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="chart-container">
              <canvas id="financialChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS MODAL -->
      <div
        class="modal fade"
        id="settingsModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div
            class="modal-content"
            style="
              background: var(--theme-bg-dark);
              border: 1px solid var(--theme-warning);
              box-shadow: 0 0 20px rgba(255, 193, 7, 0.2);
            "
          >
            <div class="modal-header border-secondary border-opacity-25">
              <h5
                class="modal-title text-warning"
                style="
                  font-family: &quot;JetBrains Mono&quot;;
                  letter-spacing: 1px;
                "
              >
                <i class="bi bi-wallet2 me-2"></i>SYSTEM CONFIGURATION
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <ul
                class="nav nav-tabs mb-3 border-secondary border-opacity-25"
                id="settingsTabs"
                role="tablist"
              >
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="wallet-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#wallet"
                    type="button"
                    role="tab"
                  >
                    Service Wallet
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="rates-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#rates"
                    type="button"
                    role="tab"
                  >
                    Unit Costs
                  </button>
                </li>
              </ul>
              <div class="tab-content" id="settingsTabsContent">
                <!-- Wallet Tab -->
                <div
                  class="tab-pane fade show active"
                  id="wallet"
                  role="tabpanel"
                >
                  <div class="row g-3">
                    <!-- Twilio -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-dark border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >TWILIO BALANCE</label
                        >
                        <div class="h4 mb-0 text-white font-monospace">
                          {{ formatMoney(wallet.twilio && wallet.twilio.balance)
                          }}
                        </div>
                        <div class="small text-muted">
                          {{ (wallet.twilio && wallet.twilio.currency) || 'USD'
                          }}
                        </div>
                      </div>
                    </div>
                    <!-- OpenRouter -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-dark border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >OPENROUTER</label
                        >
                        <div class="h4 mb-0 text-white font-monospace">
                          {{ getOpenRouterCredits(wallet) }}
                        </div>
                        <div class="small text-muted">Credits Available</div>
                      </div>
                    </div>
                    <!-- Deepgram -->
                    <div class="col-md-4">
                      <div
                        class="p-3 border rounded bg-dark border-secondary border-opacity-25"
                      >
                        <label class="text-muted small d-block mb-1"
                          >DEEPGRAM</label
                        >
                        <div class="h4 mb-0 text-white font-monospace">
                          {{ getDeepgramBalance(wallet) }}
                        </div>
                        <div class="small text-muted">Remaining Balance</div>
                      </div>
                    </div>
                    <!-- ElevenLabs -->
                    <div class="col-12 mt-4">
                      <label class="text-muted small mb-2"
                        >ELEVENLABS USAGE</label
                      >
                      <div
                        class="progress"
                        style="height: 25px; background: #333"
                      >
                        <div
                          class="progress-bar bg-warning"
                          role="progressbar"
                          :style="{ width: (100 - (((wallet.elevenlabs && wallet.elevenlabs.percent) || 0) * 100)) + '%' }"
                        >
                          {{ formatElevenLabsUsage((wallet.elevenlabs &&
                          wallet.elevenlabs.used), (wallet.elevenlabs &&
                          wallet.elevenlabs.limit)) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rates Tab -->
                <div class="tab-pane fade" id="rates" role="tabpanel">
                  <p class="text-muted small mb-4">
                    <i class="bi bi-info-circle me-1"></i> These rates determine
                    the deductions from client balances per minute of usage.
                  </p>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-white"
                      >Twilio Voice (Per Min)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-dark border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.twilio_cost_per_min"
                          step="0.0001"
                          class="form-control bg-dark text-white border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('twilio_cost_per_min')"
                      >
                        Save
                      </button>
                    </div>
                  </div>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-white"
                      >STT (Deepgram) (Per Min)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-dark border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.stt_cost_per_min"
                          step="0.0001"
                          class="form-control bg-dark text-white border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('stt_cost_per_min')"
                      >
                        Save
                      </button>
                    </div>
                  </div>

                  <div class="mb-3 row align-items-center">
                    <label class="col-sm-6 col-form-label text-white"
                      >TTS (ElevenLabs) (Per Char)</label
                    >
                    <div class="col-sm-6 d-flex gap-2">
                      <div class="input-group">
                        <span
                          class="input-group-text bg-dark border-secondary text-muted"
                          >$</span
                        >
                        <input
                          type="number"
                          v-model="rates.tts_cost_per_char"
                          step="0.00001"
                          class="form-control bg-dark text-white border-secondary font-monospace"
                        />
                      </div>
                      <button
                        class="btn btn-sm btn-outline-success"
                        @click="saveRate('tts_cost_per_char')"
                      >
                        Save
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./lib/js/vue.global.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script>
      // Global logout
      window.logout = function () {
        localStorage.removeItem("authToken");
        window.location.href = "/static/index.html";
      };

      const { createApp, ref, computed, onMounted, watch } = Vue;

      createApp({
        setup() {
          const data = ref([]);
          const loading = ref(true);
          const token = localStorage.getItem("authToken");
          let chart = null;

          // Settings State
          const wallet = ref({});
          const rates = ref({});
          const settingsModal = ref(null);

          const fetchSettings = async () => {
            try {
              const [balRes, ratesRes] = await Promise.all([
                axios.get("/api/admin/balances", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
                axios.get("/api/admin/settings", {
                  headers: { Authorization: `Bearer ${token}` },
                }),
              ]);
              wallet.value = balRes.data;
              rates.value = ratesRes.data;
            } catch (e) {
              console.error("Failed to fetch settings:", e);
            }
          };

          const saveRate = async (key) => {
            try {
              await axios.post(
                "/api/admin/settings",
                {
                  key: key,
                  value: String(rates.value[key]),
                },
                { headers: { Authorization: `Bearer ${token}` } },
              );
              alert("Rate updated successfully.");
            } catch (e) {
              console.error("Failed to save rate:", e);
              alert("Failed to update rate.");
            }
          };

          const openSettings = async () => {
            if (!settingsModal.value) {
              settingsModal.value = new bootstrap.Modal(
                document.getElementById("settingsModal"),
              );
            }
            await fetchSettings();
            settingsModal.value.show();
          };

          const totalRevenue = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_revenue || 0), 0),
          );
          const totalCost = computed(() =>
            data.value.reduce((sum, d) => sum + (d.total_cost || 0), 0),
          );
          const totalProfit = computed(() =>
            data.value.reduce((sum, d) => sum + (d.gross_profit || 0), 0),
          );
          const margin = computed(() =>
            totalRevenue.value > 0
              ? (totalProfit.value / totalRevenue.value) * 100
              : 0,
          );

          const fetchData = async () => {
            if (!token) {
              window.location.href = "/static/index.html";
              return;
            }
            try {
              loading.value = true;
              const res = await axios.get("/api/admin/analytics", {
                headers: { Authorization: `Bearer ${token}` },
              });
              data.value = res.data || [];
              renderChart();
            } catch (e) {
              console.error(e);
              if (e.response?.status === 403) {
                alert("Access Denied. Logging out.");
                logout();
              } else {
                alert("Failed to fetch analytics data.");
              }
            } finally {
              loading.value = false;
            }
          };

          const renderChart = () => {
            const ctx = document
              .getElementById("financialChart")
              ?.getContext("2d");
            if (!ctx || data.value.length === 0) return;

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
              data: {
                labels: data.value.map((d) => d.date),
                datasets: [
                  {
                    label: "Revenue ($)",
                    data: data.value.map((d) => d.total_revenue || 0),
                    backgroundColor: "rgba(34, 197, 94, 0.8)",
                    borderColor: "rgba(34, 197, 94, 1)",
                    borderWidth: 2,
                    type: "bar",
                    order: 1,
                  },
                  {
                    label: "Cost ($)",
                    data: data.value.map((d) => d.total_cost || 0),
                    borderColor: "rgba(239, 68, 68, 1)",
                    backgroundColor: "rgba(239, 68, 68, 0.1)",
                    fill: false,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 2,
                  },
                  {
                    label: "Profit ($)",
                    data: data.value.map((d) => d.gross_profit || 0),
                    borderColor: "rgba(59, 130, 246, 1)",
                    backgroundColor: "rgba(59, 130, 246, 0.2)",
                    fill: true,
                    type: "line",
                    tension: 0.3,
                    borderWidth: 3,
                    order: 3,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: { color: "rgba(255,255,255,0.1)" },
                    ticks: { color: "white" },
                  },
                  x: {
                    grid: { color: "rgba(255,255,255,0.05)" },
                    ticks: { color: "white", maxRotation: 45 },
                  },
                },
                plugins: {
                  legend: { labels: { color: "white", usePointStyle: true } },
                  tooltip: {
                    backgroundColor: "rgba(0,0,0,0.9)",
                    titleColor: "white",
                    bodyColor: "white",
                    callbacks: {
                      label: (ctx) => `$${ctx.parsed.y?.toFixed(2)}`,
                    },
                  },
                },
                interaction: { intersect: false, mode: "index" },
              },
            });
          };

          onMounted(() => {
            fetchData();
          });

          watch(data, renderChart);

          return {
            data,
            loading,
            totalRevenue,
            totalCost,
            totalProfit,
            margin,
            fetchData,
            // Settings
            wallet,
            rates,
            openSettings,
            saveRate,
            formatMoney: (val, currency = "USD") => {
              if (val === undefined || val === null) return "---";
              return "$" + parseFloat(val).toFixed(2);
            },
            formatElevenLabsUsage: (used, limit) => {
              if (!used || !limit) return "0 / 0 Chars";
              return (
                (used / 1000).toFixed(1) +
                "k / " +
                (limit / 1000).toFixed(0) +
                "k Chars"
              );
            },
            getDeepgramBalance: (w) => {
              if (
                w &&
                w.deepgram &&
                w.deepgram.balances &&
                w.deepgram.balances[0] &&
                w.deepgram.balances[0].amount
              ) {
                return (
                  "$" + parseFloat(w.deepgram.balances[0].amount).toFixed(2)
                );
              }
              return "---";
            },
            getOpenRouterCredits: (w) => {
              if (
                w &&
                w.openrouter &&
                w.openrouter.data &&
                w.openrouter.data.total_credits
              ) {
                const credits =
                  parseFloat(w.openrouter.data.total_credits) || 0;
                const usage = parseFloat(w.openrouter.data.total_usage) || 0;
                return "$" + (credits - usage).toFixed(2);
              }
              return "---";
            },
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
