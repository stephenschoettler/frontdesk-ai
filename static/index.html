<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Front Desk Admin Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app" class="container-fluid">
      <nav
        class="navbar navbar-expand-lg navbar-dark bg-primary mb-4"
        v-if="currentView === 'dashboard'"
      >
        <div class="container-fluid">
          <a
            class="navbar-brand"
            href="#"
            style="font-size: 0.7em; line-height: 1"
          >
            <pre
              class="mb-0"
              style="
                color: var(--tokyo-blue);
                font-weight: 700;
                text-shadow: 0 0 5px var(--tokyo-blue);
              "
            >
â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–„â–‘â–ˆâ–€â–ˆâ–‘â–ˆâ–€â–ˆâ–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–„â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–€â–‘â–ˆâ–‘â–ˆâ–‘â–‘â–‘â–‘â–‘â–ˆâ–€â–ˆâ–‘â–€â–ˆâ–€
â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–„â–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–€â–€â–‘â–€â–€â–ˆâ–‘â–ˆâ–€â–„â–‘â–„â–„â–„â–‘â–ˆâ–€â–ˆâ–‘â–‘â–ˆâ–‘
â–‘â–€â–‘â–‘â–‘â–€â–‘â–€â–‘â–€â–€â–€â–‘â–€â–‘â–€â–‘â–‘â–€â–‘â–‘â–€â–€â–‘â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–‘â–€â–‘â–‘â–‘â–‘â–‘â–€â–‘â–€â–‘â–€â–€â–€
</pre
            >
          </a>
          <div class="navbar-nav ms-auto">
            <span class="nav-item nav-link"
              >Total Clients: {{ clients.length }}</span
            >
            <span class="nav-item nav-link" v-if="currentUser"
              >Logged in as: {{ currentUser }}</span
            >
            <button @click="logout" class="btn btn-danger btn-sm ms-3">
              Logout
            </button>
          </div>
        </div>
      </nav>

      <div
        v-if="currentView !== 'dashboard'"
        class="d-flex justify-content-center align-items-center"
        style="min-height: 80vh"
      >
        <div class="card p-4 shadow-lg" style="width: 400px">
          <div class="card-header text-center">
            <h5 class="mb-0">
              {{ currentView === 'login' ? 'Login' : 'Register' }} to Front Desk
              AI
            </h5>
          </div>
          <div class="card-body">
            <form
              @submit.prevent="currentView === 'login' ? login() : register()"
            >
              <div class="mb-3">
                <label for="authEmail" class="form-label">Email address</label>
                <input
                  type="email"
                  class="form-control"
                  id="authEmail"
                  v-model="authForm.email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="authPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="authPassword"
                  v-model="authForm.password"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100 mb-2">
                {{ currentView === 'login' ? 'Login' : 'Register' }}
              </button>
              <p class="text-center mt-2">
                <a href="#" @click.prevent="toggleAuthView">
                  {{ currentView === 'login' ? 'Need an account? Register' :
                  'Already have an account? Login' }}
                </a>
              </p>
              <div v-if="authError" class="alert alert-danger mt-3">
                {{ authError }}
              </div>
            </form>
          </div>
        </div>
      </div>

      <div v-if="currentView === 'dashboard'" class="row">
        <div class="col-md-12">
          <ul class="nav nav-tabs mb-4 align-items-end">
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: activeTab === 'clients' }"
                href="#"
                @click.prevent="activeTab = 'clients'"
                >Clients</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: activeTab === 'contacts' }"
                href="#"
                @click.prevent="activeTab = 'contacts'"
                >Contacts</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                :class="{ active: activeTab === 'logs' }"
                href="#"
                @click.prevent="activeTab = 'logs'"
                >Call Logs</a
              >
            </li>

            <li class="ms-auto pb-1">
              <button
                @click="showCreateModal = true"
                class="btn btn-success btn-sm me-2"
              >
                Create New Client
              </button>
              <button
                @click="showBulkModal = true"
                v-if="selectedClients.length > 0"
                class="btn btn-warning btn-sm"
              >
                Bulk Actions
              </button>
            </li>
          </ul>

          <div v-if="activeTab === 'clients'">
            <div class="row mb-3">
              <div class="col-md-4">
                <input
                  v-model="searchQuery"
                  @input="filterClients"
                  type="text"
                  class="form-control"
                  placeholder="Search clients..."
                />
              </div>
              <div class="col-md-2">
                <select
                  v-model="filterStatus"
                  @change="filterClients"
                  class="form-select"
                >
                  <option value="">All Status</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div class="col-md-2">
                <select
                  v-model="sortBy"
                  @change="sortClients"
                  class="form-select"
                >
                  <option value="name">Sort by Name</option>
                  <option value="created_at">Sort by Created</option>
                </select>
              </div>
              <div class="col-md-2">
                <button @click="exportClients" class="btn btn-outline-primary">
                  Export
                </button>
              </div>
            </div>

            <div class="row">
              <div
                v-for="client in filteredClients"
                :key="client.id"
                class="col-md-6 col-lg-4 mb-4"
              >
                <div class="card client-card h-100">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5 class="card-title mb-0">{{ client.name }}</h5>
                    <span
                      :class="['status-indicator', client.cell ? 'status-active' : 'status-inactive']"
                    ></span>
                  </div>
                  <div class="card-body">
                    <p class="card-text">
                      <strong>Cell:</strong> {{ client.cell || 'Not set' }}
                    </p>
                    <p class="card-text">
                      <strong>Timezone:</strong> {{ client.business_timezone }}
                    </p>
                    <p class="card-text">
                      <strong>Hours:</strong> {{
                      formatHour(client.business_start_hour) }} - {{
                      formatHour(client.business_end_hour) }}
                    </p>
                    <p class="card-text">
                      <strong>LLM Model:</strong> {{ client.llm_model }}
                    </p>
                    <div
                      class="mt-2"
                      v-if="client.enabled_tools && client.enabled_tools.length"
                    >
                      <small class="text-muted">Tools: </small>
                      <span
                        v-for="tool in client.enabled_tools"
                        :key="tool"
                        class="badge bg-secondary me-1"
                        style="font-size: 0.7em"
                        >{{ formatToolName(tool) }}</span
                      >
                    </div>
                    <small class="text-muted d-block mt-2"
                      >Created: {{ formatDate(client.created_at) }}</small
                    >
                  </div>
                  <div
                    class="card-footer d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <button
                        @click="editClient(client)"
                        class="btn btn-primary btn-sm me-2"
                      >
                        Edit
                      </button>
                      <button
                        @click="duplicateClient(client)"
                        class="btn btn-secondary btn-sm me-2"
                      >
                        Duplicate
                      </button>
                      <button
                        @click="deleteClient(client.id)"
                        class="btn btn-danger btn-sm"
                      >
                        Delete
                      </button>
                    </div>
                    <div class="form-check m-0">
                      <input
                        type="checkbox"
                        v-model="selectedClients"
                        :value="client.id"
                        class="form-check-input"
                        title="Select for bulk action"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <nav v-if="totalPages > 1" aria-label="Client pagination">
              <ul class="pagination justify-content-center">
                <li class="page-item" :class="{ disabled: currentPage === 1 }">
                  <a
                    class="page-link"
                    href="#"
                    @click.prevent="currentPage--"
                    v-if="currentPage > 1"
                    >Previous</a
                  >
                </li>
                <li
                  v-for="page in visiblePages"
                  :key="page"
                  class="page-item"
                  :class="{ active: page === currentPage }"
                >
                  <a
                    class="page-link"
                    href="#"
                    @click.prevent="currentPage = page"
                    >{{ page }}</a
                  >
                </li>
                <li
                  class="page-item"
                  :class="{ disabled: currentPage === totalPages }"
                >
                  <a
                    class="page-link"
                    href="#"
                    @click.prevent="currentPage++"
                    v-if="currentPage < totalPages"
                    >Next</a
                  >
                </li>
              </ul>
            </nav>
          </div>

          <div v-if="activeTab === 'contacts'" class="contacts-tab">
            <div class="row mb-3">
              <div class="col-md-4">
                <input
                  v-model="contactSearchQuery"
                  type="text"
                  class="form-control"
                  placeholder="Search contacts..."
                />
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark">
                <thead>
                  <tr>
                    <th>Phone Number</th>
                    <th>Name</th>
                    <th>Client</th>
                    <th>Last Contact</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="contact in filteredContacts" :key="contact.phone">
                    <td>{{ contact.phone }}</td>
                    <td>{{ contact.name }}</td>
                    <td>{{ contact.client_name }}</td>
                    <td>{{ formatDate(contact.last_contact) }}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-2">
                        View History
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div v-if="activeTab === 'logs'" class="logs-tab">
            <div class="row mb-3">
              <div class="col-md-4">
                <input
                  v-model="logSearchQuery"
                  type="text"
                  class="form-control"
                  placeholder="Search logs..."
                />
              </div>
              <div class="col-md-3">
                <select v-model="logFilterClient" class="form-select">
                  <option value="">All Clients</option>
                  <option
                    v-for="client in clients"
                    :key="client.id"
                    :value="client.id"
                  >
                    {{ client.name }}
                  </option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="table-responsive">
                  <table class="table table-dark">
                    <thead>
                      <tr>
                        <th>Date/Time</th>
                        <th>Client</th>
                        <th>Phone</th>
                        <th>Duration</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr
                        v-for="log in filteredCallLogs"
                        :key="log.id"
                        @click="selectedTranscript = log"
                        :class="{ 'selected': selectedTranscript?.id === log.id }"
                        style="cursor: pointer"
                      >
                        <td>{{ formatDate(log.timestamp) }}</td>
                        <td>{{ log.client_name }}</td>
                        <td>{{ log.phone }}</td>
                        <td>{{ log.duration }}s</td>
                        <td>{{ log.status }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6" v-if="selectedTranscript">
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">Call Transcript</h6>
                  </div>
                  <div class="card-body">
                    <div class="conversation-transcript">
                      <template
                        v-for="(message, index) in selectedTranscript.transcript"
                        :key="index"
                      >
                        <div
                          v-if="message.role === 'user'"
                          class="message user"
                        >
                          <strong>Caller:</strong>
                          <p>{{ message.content }}</p>
                        </div>

                        <div
                          v-else-if="message.role === 'assistant' && message.content"
                          class="message assistant"
                        >
                          <strong>Assistant:</strong>
                          <p>{{ message.content }}</p>
                        </div>

                        <div
                          v-if="message.role === 'assistant' && message.tool_calls"
                          class="message tool"
                        >
                          <strong style="color: var(--tokyo-orange)"
                            >âš¡ System Action:</strong
                          >
                          <div
                            v-for="tool in message.tool_calls"
                            :key="tool.id"
                            class="mb-1"
                          >
                            <span class="text-warning"
                              >{{ tool.function.name }}</span
                            >
                            <span class="text-muted"
                              >({{ tool.function.arguments }})</span
                            >
                          </div>
                        </div>

                        <div
                          v-else-if="message.role === 'tool'"
                          class="message tool"
                        >
                          <strong style="color: var(--tokyo-green)"
                            >âœ“ Tool Result:</strong
                          >
                          <p style="white-space: pre-wrap">
                            {{ message.content }}
                          </p>
                        </div>
                      </template>

                      <div
                        v-if="!selectedTranscript.transcript || selectedTranscript.transcript.length === 0"
                        class="text-muted text-center mt-4"
                      >
                        Select a log to view transcript.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade"
        :class="{ show: showCreateModal || showEditModal }"
        :style="{ display: (showCreateModal || showEditModal) ? 'block' : 'none' }"
        tabindex="-1"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                {{ showEditModal ? 'Edit Client' : 'Create New Client' }}
              </h5>
              <button
                type="button"
                class="btn-close"
                @click="closeModal"
              ></button>
            </div>
            <div class="modal-body">
              <form @submit.prevent="saveClient">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Name *</label>
                      <input
                        v-model="clientForm.name"
                        type="text"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Cell Phone</label>
                      <input
                        v-model="clientForm.cell"
                        type="text"
                        class="form-control"
                        placeholder="+15551234567"
                      />
                      <div class="form-text text-muted">
                        Must match Twilio 'To' number.
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Calendar ID</label>
                      <input
                        v-model="clientForm.calendar_id"
                        type="text"
                        class="form-control"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Business Timezone</label>
                      <select
                        v-model="clientForm.business_timezone"
                        class="form-select"
                      >
                        <option value="America/Los_Angeles">
                          America/Los_Angeles
                        </option>
                        <option value="America/New_York">
                          America/New_York
                        </option>
                        <option value="America/Chicago">America/Chicago</option>
                        <option value="America/Denver">America/Denver</option>
                      </select>
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Start Hour</label>
                          <select
                            v-model.number="clientForm.business_start_hour"
                            class="form-select"
                          >
                            <option v-for="h in 24" :key="h-1" :value="h-1">
                              {{ formatHour(h-1) }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">End Hour</label>
                          <select
                            v-model.number="clientForm.business_end_hour"
                            class="form-select"
                          >
                            <option v-for="h in 24" :key="h-1" :value="h-1">
                              {{ formatHour(h-1) }}
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">LLM Model</label>
                      <select
                        v-model="clientForm.llm_model"
                        class="form-select"
                      >
                        <option value="openai/gpt-4o-mini">
                          openai/gpt-4o-mini
                        </option>
                        <option value="openai/gpt-4">openai/gpt-4</option>
                        <option value="anthropic/claude-3-haiku">
                          anthropic/claude-3-haiku
                        </option>
                      </select>
                    </div>

                    <div
                      class="mb-3 border p-2 rounded"
                      style="background: var(--tokyo-bg-dark)"
                    >
                      <label class="form-label mb-2 text-warning"
                        >Enabled AI Tools</label
                      >
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="get_available_slots"
                          v-model="clientForm.enabled_tools"
                          id="tool_slots"
                        />
                        <label class="form-check-label" for="tool_slots"
                          >Check Availability</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="book_appointment"
                          v-model="clientForm.enabled_tools"
                          id="tool_book"
                        />
                        <label class="form-check-label" for="tool_book"
                          >Book Appointments</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="save_contact_name"
                          v-model="clientForm.enabled_tools"
                          id="tool_save"
                        />
                        <label class="form-check-label" for="tool_save"
                          >Save Contact Names</label
                        >
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">TTS Voice ID</label>
                      <input
                        v-model="clientForm.tts_voice_id"
                        type="text"
                        class="form-control"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Initial Greeting</label>
                      <textarea
                        v-model="clientForm.initial_greeting"
                        class="form-control"
                        rows="2"
                      ></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">System Prompt</label>
                      <textarea
                        v-model="clientForm.system_prompt"
                        class="form-control"
                        rows="4"
                      ></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Use Template</label>
                      <select
                        v-model="selectedTemplate"
                        @change="applyTemplate"
                        class="form-select template-selector"
                      >
                        <option value="">Select Template</option>
                        <option value="default">Default Front Desk</option>
                        <option value="spa">Spa/Reception</option>
                        <option value="restaurant">Restaurant</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    @click="closeModal"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    class="btn btn-primary"
                    :disabled="saving"
                  >
                    {{ saving ? 'Saving...' : 'Save' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade"
        :class="{ show: showBulkModal }"
        :style="{ display: showBulkModal ? 'block' : 'none' }"
        tabindex="-1"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Bulk Actions</h5>
              <button
                type="button"
                class="btn-close"
                @click="showBulkModal = false"
              ></button>
            </div>
            <div class="modal-body">
              <p>Selected {{ selectedClients.length }} clients</p>
              <button @click="bulkDelete" class="btn btn-danger me-2">
                Delete Selected
              </button>
              <button @click="bulkUpdate" class="btn btn-warning">
                Update Field
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="position-fixed bottom-0 end-0 m-4" style="z-index: 1050">
        <div
          class="card shadow-lg border-info"
          v-if="showAuditLog"
          style="width: 300px"
        >
          <div
            class="card-header d-flex justify-content-between align-items-center py-2 bg-dark border-bottom border-secondary"
          >
            <h6 class="mb-0 text-info">System Activity</h6>
            <button
              @click="showAuditLog = false"
              class="btn-close btn-close-white btn-sm"
            ></button>
          </div>
          <div
            class="card-body audit-log p-2"
            style="
              max-height: 250px;
              overflow-y: auto;
              background: var(--tokyo-bg-dark);
            "
          >
            <div
              v-for="log in auditLogs"
              :key="log.id"
              class="mb-2 border-bottom border-secondary pb-1"
            >
              <div class="d-flex justify-content-between">
                <span
                  :class="log.type === 'create' ? 'text-success' : log.type === 'update' ? 'text-warning' : 'text-danger'"
                  style="font-size: 0.8rem; font-weight: bold"
                >
                  {{ log.action }}
                </span>
              </div>
              <small class="text-muted" style="font-size: 0.7rem"
                >{{ formatDate(log.timestamp) }}</small
              >
            </div>
            <div
              v-if="auditLogs.length === 0"
              class="text-muted text-center small my-2"
            >
              No recent activity.
            </div>
          </div>
        </div>
        <button
          v-else
          @click="showAuditLog = true"
          class="btn btn-outline-info rounded-pill shadow-lg"
        >
          <span class="me-2">ðŸ“‹</span>Audit Log
        </button>
      </div>
    </div>

    <script src="app.js"></script>
  </body>
</html>
