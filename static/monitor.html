<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FrontDesk // Overwatch</title>
    <link href="./lib/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=2" />

    <style>
      /* Admin-specific overrides */
      body {
        padding-bottom: 50px;
      }
      .border-red {
        border-color: var(--theme-red) !important;
      }
      .stat-card {
        background: var(--theme-bg-dark) !important;
        border: 1px solid var(--theme-bg-mid) !important;
      }
      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--theme-fg);
      }
      .stat-label {
        color: var(--theme-muted);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.75rem;
      }
      /* Make the user row clickable and obvious */
      .user-row {
        cursor: pointer;
      }

      /* --- FIX FOR VUE MANUAL MODALS (No Backdrop Element) --- */
      /* Since there is no .modal-backdrop div, we dim the .modal container itself */
      #app .modal.show {
        background-color: rgba(0, 0, 0, 0.6) !important; /* The Dim */
        -webkit-backdrop-filter: blur(8px) !important; /* The Blur */
        backdrop-filter: blur(8px) !important;
      }

      /* --- FOR BOOTSTRAP MODALS (Monitor.html) --- */
      .modal-backdrop.show {
        background-color: rgba(0, 0, 0, 0.35) !important; /* Subtle Frost */
        -webkit-backdrop-filter: blur(8px) !important;
        backdrop-filter: blur(8px) !important;
        opacity: 1 !important;
      }
      .user-row:hover {
        transition: background 0.2s;
        background: rgba(125, 207, 255, 0.05) !important;
      }
      .user-row.active-row {
        border-left: 3px solid var(--theme-purple);
        background: rgba(187, 154, 247, 0.05) !important;
      }
      /* Dark Tabs */
      .nav-tabs {
        border-bottom: 1px solid var(--theme-bg-mid);
      }
      .nav-tabs .nav-link {
        color: var(--theme-comment);
        border: none;
        border-bottom: 2px solid transparent;
      }
      .nav-tabs .nav-link:hover {
        color: var(--theme-fg);
        border-color: var(--theme-bg-mid);
      }
      .nav-tabs .nav-link.active {
        color: var(--theme-purple) !important;
        background: transparent !important;
        border-bottom: 2px solid var(--theme-purple) !important;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container-fluid p-4">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
          <span class="navbar-brand mb-0">
            <i class="bi bi-eye-fill me-2"></i>OVERWATCH
          </span>
          <div class="navbar-nav ms-auto d-flex align-items-center gap-2">
            <a href="analytics.html" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-bar-chart me-1"></i>ANALYTICS
            </a>
            <button class="btn btn-sm btn-outline-secondary" @click="openSettings">
              <i class="bi bi-gear"></i>
            </button>
            <button
              class="btn btn-sm btn-outline-secondary"
              @click="showDebug = !showDebug"
            >
              <i class="bi bi-bug me-1"></i>{{ showDebug ? 'HIDE DEBUG' : 'DEBUG' }}
            </button>
            <button class="btn btn-sm btn-outline-secondary" @click="fetchData">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <a
              href="javascript:void(0)"
              onclick="logout()"
              class="btn btn-sm btn-outline-secondary"
            >
              <i class="bi bi-box-arrow-right"></i>
            </a>
          </div>
        </div>
      </nav>

      <div
        v-if="isLoading"
        class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
        style="z-index: 2000; background: var(--theme-bg);"
      >
        <div class="text-center">
          <div
            class="spinner-border text-purple mb-3"
            role="status"
            style="width: 4rem; height: 4rem"
          ></div>
          <h4>Initializing Overwatch...</h4>
          <p class="text-muted">Loading users, clients & live data...</p>
        </div>
      </div>
      <div v-else>

      <!-- Stats Row -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card p-3">
            <div class="stat-label">USERS</div>
            <div class="stat-value">{{ users.length }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card p-3">
            <div class="stat-label">CLIENTS</div>
            <div class="stat-value">{{ clients.length }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card p-3">
            <div class="stat-label">BALANCE RESERVE</div>
            <div class="stat-value">{{ formatDuration(totalSystemBalance) }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card p-3">
            <div class="stat-label">ORPHANED</div>
            <div class="stat-value">{{ orphanClients }}</div>
          </div>
        </div>
      </div>

      <!-- Debug Info -->
      <div v-if="showDebug" class="card mb-4">
        <div class="card-header">
          <i class="bi bi-bug me-2"></i>DEBUG INFO
        </div>
        <div class="card-body p-3" style="font-family: 'JetBrains Mono', monospace; max-height: 200px; overflow-y: auto; font-size: 0.85rem;">
          <div class="text-muted">> TIMESTAMP: {{ new Date().toISOString() }}</div>
          <div class="text-fg">> USERS: {{ users.length }}</div>
          <div class="text-fg">> CLIENTS: {{ clients.length }}</div>
          <div v-for="u in users.slice(0,3)" :key="u.id" class="text-muted small">
            > {{ u.email }} [{{ u.id }}]
          </div>
        </div>
      </div>

      <!-- Live Calls -->
      <div v-if="activeCalls.length > 0" class="mb-4">
        <div class="card border-red" style="background: color-mix(in srgb, var(--theme-red), transparent 95%)">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-broadcast me-2 pulse-icon"></i>LIVE CALLS</span>
            <span class="badge bg-danger">{{ activeCalls.length }}</span>
          </div>
          <div class="card-body d-flex gap-3 overflow-auto">
            <div
              v-for="call in activeCalls"
              :key="call.call_id"
              class="card p-3 flex-shrink-0"
              style="width: 280px; background: var(--theme-bg-dark) !important;"
            >
              <div class="d-flex justify-content-between mb-2">
                <span class="text-red fw-bold small text-uppercase">ACTIVE</span>
                <span class="small text-muted">{{ formatDuration(calculateDuration(call.start_time)) }}</span>
              </div>
              <div class="text-purple fw-bold mb-1">{{ call.client_name }}</div>
              <div class="text-muted small">{{ call.caller_phone }}</div>
              <div class="mt-2 pt-2 border-top border-secondary border-opacity-25">
                <small class="text-muted">{{ truncateId(call.owner_user_id) }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Usage Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card stat-card p-3">
            <div class="stat-label">DAILY USAGE</div>
            <div class="stat-value">{{ formatDuration(total_usage_today) }}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card stat-card p-3">
            <div class="stat-label">MONTHLY USAGE</div>
            <div class="stat-value">{{ formatDuration(total_usage_month) }}</div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card h-100">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <span class="text-blue">USER DIRECTORY</span>
              <input
                type="text"
                v-model="userSearch"
                class="form-control form-control-sm w-50"
                placeholder="Filter email..."
                style="background: transparent"
              />
            </div>
            <div
              class="card-body p-0 table-responsive"
              style="max-height: calc(100vh - 400px); min-height: 500px;"
            >
              <table class="table table-custom table-hover mb-0">
                <thead>
                  <tr>
                    <th>User / Email</th>
                    <th class="text-end">Clients</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="u in filteredUsers"
                    :key="u.id"
                    class="user-row"
                    :class="{ 'active-row': selectedUser && selectedUser.id === u.id, 'opacity-50': !u.is_active }"
                    @click="selectUser(u)"
                  >
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="me-2">
                          <i
                            class="bi bi-person-circle text-muted"
                            style="font-size: 1.2rem"
                          ></i>
                        </div>
                        <div>
                          <div
                            class="fw-bold text-fg"
                            :class="{ 'text-decoration-line-through': !u.is_active }"
                          >
                            {{ u.email }}
                          </div>
                          <div class="small text-muted font-monospace">
                            {{ u.id.substring(0,8) }}...
                          </div>
                        </div>
                      </div>
                      <span
                        v-if="u.email === 'admin@frontdesk.com'"
                        class="badge border border-danger text-danger mt-1"
                        >SUPER ADMIN</span
                      >
                      <span
                        v-if="!u.is_active"
                        class="badge bg-danger mt-1 ms-1"
                        >BANNED</span
                      >
                    </td>
                    <td class="text-end align-middle">
                      <span class="badge bg-secondary text-blue"
                        >{{ getClientCount(u.id) }}</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div
            v-if="!selectedUser"
            class="h-100 d-flex flex-column justify-content-center align-items-center text-muted border border-secondary border-opacity-25 rounded p-5"
          >
            <i class="bi bi-terminal mb-3" style="font-size: 3rem; opacity: 0.3"></i>
            <div class="text-uppercase" style="letter-spacing: 2px">SELECT USER</div>
            <p class="small text-muted">View clients, balances, and activity</p>
          </div>

          <div v-else class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small text-uppercase">USER</div>
                <div class="text-purple fw-bold">{{ selectedUser.email }}</div>
              </div>
              <div class="text-muted small">{{ selectedUser.id }}</div>
            </div>

            <div class="card-body">
              <div class="row mb-4 g-2">
                <div class="col-md-3">
                  <div class="p-3 border border-secondary border-opacity-25 rounded" style="background: rgba(255,255,255,0.02)">
                    <div class="text-muted small mb-1">BALANCE</div>
                    <div class="h5 mb-0 text-fg">{{ formatDuration(getUserTotalBalance(selectedUser.id)) }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="p-3 border border-secondary border-opacity-25 rounded" style="background: rgba(255,255,255,0.02)">
                    <div class="text-muted small mb-1">DAILY</div>
                    <div class="h5 mb-0 text-fg">{{ formatDuration(getUserTotalUsage(selectedUser.id, 'usage_today')) }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="p-3 border border-secondary border-opacity-25 rounded" style="background: rgba(255,255,255,0.02)">
                    <div class="text-muted small mb-1">MONTHLY</div>
                    <div class="h5 mb-0 text-fg">{{ formatDuration(getUserTotalUsage(selectedUser.id, 'usage_month')) }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="p-3 border border-secondary border-opacity-25 rounded" style="background: rgba(255,255,255,0.02)">
                    <div class="text-muted small mb-1">CLIENTS</div>
                    <div class="h5 mb-0 text-fg">{{ getClientCount(selectedUser.id) }}</div>
                  </div>
                </div>
              </div>

              <h6
                class="text-blue border-bottom border-secondary border-opacity-25 pb-2 mb-3"
              >
                <i class="bi bi-robot me-2"></i>DEPLOYED AGENTS
              </h6>

              <div
                v-if="getUserClients(selectedUser.id).length === 0"
                class="alert alert-secondary bg-transparent border-secondary text-muted"
              >
                No clients provisioned for this user.
              </div>

              <div v-else class="table-responsive" style="max-height: calc(100vh - 600px); overflow-y: auto;">
                <table class="table table-custom align-middle">
                  <thead>
                    <tr>
                      <th>Client Name</th>
                      <th>Phone</th>
                      <th>Status</th>
                      <th>Balance</th>
                      <th>Daily</th>
                      <th>Monthly</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="c in getUserClients(selectedUser.id)"
                      :key="c.id"
                      @click="selectClient(c)"
                      class="user-row"
                      :class="{ 'active-row': selectedClient && selectedClient.id === c.id }"
                    >
                      <td>
                        <span class="fw-bold">{{ c.name }}</span><br />
                        <span class="small text-muted font-monospace"
                          >{{ c.id }}</span
                        >
                      </td>
                      <td>
                        <span class="font-monospace text-info"
                          >{{ c.cell || '---' }}</span
                        >
                      </td>
                      <td>
                        <span
                          v-if="!c.is_active"
                          class="badge bg-danger text-white"
                          >OFFLINE</span
                        >
                        <span
                          v-else-if="(c.balance_seconds || 0) < 60"
                          class="badge bg-warning text-dark"
                          >LOW FUEL</span
                        >
                        <span v-else class="badge bg-success text-white"
                          >ONLINE</span
                        >
                      </td>
                      <td class="font-monospace">
                        {{ formatDuration(c.balance_seconds || 0) }}
                      </td>
                      <td class="font-monospace text-info small">
                        {{ formatDuration(c.usage_today) }}
                      </td>
                      <td class="font-monospace text-success small">
                        {{ formatDuration(c.usage_month) }}
                      </td>
                      <td class="text-end">
                        <button
                          class="btn btn-sm btn-outline-primary me-1"
                          @click.stop="openEditModal(c)"
                        >
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button
                          class="btn btn-sm btn-outline-secondary border-0"
                          @click.stop="openHistoryModal(c)"
                        >
                          <i class="bi bi-clock-history"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div
              class="card-footer bg-transparent border-top border-secondary border-opacity-25 text-end"
            >
              <button
                v-if="getUserClients(selectedUser.id).length > 0"
                class="btn btn-sm me-2"
                :class="selectedClient && selectedClient.is_active ? 'btn-outline-danger' : 'btn-outline-success'"
                @click="selectedClient && toggleClientStatus(selectedClient)"
                :disabled="!selectedClient"
              >
                <i
                  class="bi"
                  :class="selectedClient && selectedClient.is_active ? 'bi-power' : 'bi-plug'"
                ></i>
                {{ selectedClient ? (selectedClient.is_active ? 'DISABLE CLIENT' : 'ENABLE CLIENT') : 'SELECT A CLIENT' }}
              </button>
              <button
                class="btn btn-sm"
                :class="selectedUser.is_active ? 'btn-outline-danger' : 'btn-outline-success'"
                @click="toggleUserStatus(selectedUser)"
              >
                <i
                  class="bi"
                  :class="selectedUser.is_active ? 'bi-ban' : 'bi-check-circle'"
                ></i>
                {{ selectedUser.is_active ? 'DISABLE USER' : 'ENABLE USER' }}
              </button>
              <button
                class="btn btn-sm btn-outline-secondary ms-2"
                @click="openLedgerModal"
              >
                <i class="bi bi-credit-card"></i> ADJUST LEDGER
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADJUST LEDGER MODAL -->
      <div class="modal fade" id="ledgerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div
            class="modal-content"
            style="
              background: var(--theme-bg-dark);
              border: 1px solid var(--theme-purple);
              box-shadow: 0 0 20px rgba(187, 154, 247, 0.2);
            "
          >
            <div class="modal-header border-secondary border-opacity-25">
              <h5
                class="modal-title text-purple"
                style="
                  font-family: &quot;JetBrains Mono&quot;;
                  letter-spacing: 1px;
                "
              >
                <i class="bi bi-bank me-2"></i>ADJUST LEDGER
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form @submit.prevent="submitLedger">
                <div class="mb-3">
                  <label class="form-label text-muted small"
                    >TARGET CLIENT</label
                  >
                  <select
                    v-model="ledgerForm.client_id"
                    class="form-select bg-dark text-white border-secondary"
                    style="font-family: &quot;JetBrains Mono&quot;"
                    required
                  >
                    <option
                      v-for="c in availableClients"
                      :key="c.id"
                      :value="c.id"
                    >
                      {{ c.name }} ({{ formatDuration(c.balance_seconds) }})
                    </option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label text-muted small">ACTION</label>
                  <div class="btn-group w-100" role="group">
                    <input
                      type="radio"
                      class="btn-check"
                      name="ledgerAction"
                      id="actionCredit"
                      value="credit"
                      v-model="ledgerForm.action"
                    />
                    <label class="btn btn-outline-success" for="actionCredit"
                      >CREDIT (+)</label
                    >

                    <input
                      type="radio"
                      class="btn-check"
                      name="ledgerAction"
                      id="actionDebit"
                      value="debit"
                      v-model="ledgerForm.action"
                    />
                    <label class="btn btn-outline-danger" for="actionDebit"
                      >DEBIT (-)</label
                    >
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label text-muted small"
                    >AMOUNT (MINUTES)</label
                  >
                  <input
                    type="number"
                    v-model="ledgerForm.amount_minutes"
                    class="form-control bg-dark text-white border-secondary"
                    style="font-family: &quot;JetBrains Mono&quot;"
                    min="1"
                    required
                  />
                  <div class="form-text text-end font-monospace text-muted">
                    = {{ (ledgerForm.amount_minutes || 0) * 60 }} seconds
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label text-muted small"
                    >MEMO / REASON</label
                  >
                  <input
                    type="text"
                    v-model="ledgerForm.reason"
                    class="form-control bg-dark text-white border-secondary"
                    style="font-family: &quot;JetBrains Mono&quot;"
                    placeholder="0.00"
                  />
                </div>

                <div class="mb-3" v-if="ledgerForm.action === 'credit'">
                  <label class="form-label text-muted small"
                    >Revenue (USD)</label
                  >
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    v-model.number="ledgerForm.revenue_usd"
                    class="form-control bg-dark text-white border-secondary"
                    placeholder="0.00"
                  />
                  <div class="form-text text-muted">
                    Stripe/cash payment logged for P&L.
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label text-muted small"
                    >MEMO / REASON</label
                  >
                  <input
                    type="text"
                    v-model="ledgerForm.reason"
                    class="form-control bg-dark text-white border-secondary"
                    style="font-family: &quot;JetBrains Mono&quot;"
                    placeholder="e.g. Monthly Top-up"
                    required
                  />
                </div>

                <div class="text-end mt-4">
                  <button
                    type="button"
                    class="btn btn-outline-secondary me-2"
                    data-bs-dismiss="modal"
                  >
                    CANCEL
                  </button>
                  <button
                    type="submit"
                    class="btn btn-outline-success"
                    :disabled="isSubmitting"
                  >
                    <span
                      v-if="isSubmitting"
                      class="spinner-border spinner-border-sm me-2"
                    ></span>
                    CONFIRM TRANSACTION
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- EDIT CLIENT MODAL -->
      <div
        class="modal fade"
        id="editClientModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div
            class="modal-content"
            style="
              background: var(--theme-bg-dark);
              border: 1px solid var(--theme-purple);
              box-shadow: 0 0 20px rgba(187, 154, 247, 0.2);
            "
          >
            <div class="modal-header">
              <h5 class="modal-title">
                Edit Client
              </h5>

              <div class="ms-auto d-flex align-items-center gap-3">
                <button
                  type="submit"
                  form="editClientForm"
                  class="btn btn-sm btn-edit"
                  :disabled="isSubmitting"
                >
                  {{ isSubmitting ? 'SAVING...' : 'SAVE' }}
                </button>
                <button
                  type="button"
                  class="btn-close m-0"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
            </div>
            <div class="modal-body">
              <!-- Full-screen System Prompt Editor -->
              <div
                v-if="systemPromptExpanded"
                class="system-prompt-fullscreen"
                style="
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  z-index: 2000;
                  background: var(--theme-bg-dark);
                  padding: 20px;
                  display: flex;
                  flex-direction: column;
                "
              >
                <div
                  class="d-flex justify-content-between align-items-center mb-3"
                >
                  <h5 class="mb-0 text-white">System Prompt Editor</h5>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    @click="toggleSystemPromptExpansion"
                  >
                    ‚Üê Back to Form
                  </button>
                </div>
                <textarea
                  v-model="editForm.system_prompt"
                  class="form-control bg-dark text-white border-secondary system-prompt-fullscreen-textarea"
                  style="flex-grow: 1; font-family: &quot;JetBrains Mono&quot;"
                  placeholder="Enter your system prompt here..."
                ></textarea>
              </div>

              <!-- Normal Form View -->
              <form
                v-else
                id="editClientForm"
                @submit.prevent="submitEditClient"
              >
                <ul class="nav nav-tabs mb-3">
                  <li class="nav-item">
                    <a
                      class="nav-link"
                      :class="{ active: activeClientTab === 'basic' }"
                      href="#"
                      @click.prevent="activeClientTab = 'basic'"
                      >Basic Info</a
                    >
                  </li>
                  <li class="nav-item">
                    <a
                      class="nav-link"
                      :class="{ active: activeClientTab === 'ai' }"
                      href="#"
                      @click.prevent="activeClientTab = 'ai'"
                      >AI Config</a
                    >
                  </li>
                  <li class="nav-item">
                    <a
                      class="nav-link"
                      :class="{ active: activeClientTab === 'prompting' }"
                      href="#"
                      @click.prevent="activeClientTab = 'prompting'"
                      >Prompting</a
                    >
                  </li>
                  <li class="nav-item">
                    <a
                      class="nav-link"
                      :class="{ active: activeClientTab === 'tools' }"
                      href="#"
                      @click.prevent="activeClientTab = 'tools'"
                      >Tools</a
                    >
                  </li>
                </ul>

                <div class="tab-content">
                  <div v-if="activeClientTab === 'basic'">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Name *</label>
                          <input
                            v-model="editForm.name"
                            type="text"
                            class="form-control"
                            required
                          />
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Cell Phone</label>
                          <input
                            v-model="editForm.cell"
                            type="text"
                            class="form-control"
                          />
                          <div class="form-text text-muted">
                            Admin Override: Enter full E.164 format (e.g.
                            +14155551234).
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Calendar ID</label>
                          <input
                            v-model="editForm.calendar_id"
                            type="text"
                            class="form-control"
                          />
                        </div>
                        
                        <!-- Admin Specific Active Switch -->
                        <div class="mb-3 p-3 border rounded">
                           <div class="form-check form-switch">
                             <input class="form-check-input" type="checkbox" id="clientLockSwitch" v-model="editForm.is_locked" />
                             <label class="form-check-label ms-2" for="clientLockSwitch">LOCK AGENT (Admin Only)</label>
                           </div>
                           <div class="form-text text-muted small mt-2">
                             <i class="bi bi-shield-lock"></i> Prevents the user from enabling this agent.
                           </div>
                        </div>

                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">Business Timezone</label>
                          <select
                            v-model="editForm.business_timezone"
                            class="form-select"
                          >
                            <option value="America/Los_Angeles">
                              America/Los_Angeles
                            </option>
                            <option value="America/New_York">
                              America/New_York
                            </option>
                            <option value="America/Chicago">
                              America/Chicago
                            </option>
                            <option value="America/Denver">
                              America/Denver
                            </option>
                          </select>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label class="form-label">Start Hour</label>
                              <select
                                v-model.number="editForm.business_start_hour"
                                class="form-select"
                              >
                                <option v-for="h in 24" :key="h-1" :value="h-1">
                                  {{ formatHour(h-1) }}
                                </option>
                              </select>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label class="form-label">End Hour</label>
                              <select
                                v-model.number="editForm.business_end_hour"
                                class="form-select"
                              >
                                <option v-for="h in 24" :key="h-1" :value="h-1">
                                  {{ formatHour(h-1) }}
                                </option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div v-if="activeClientTab === 'ai'">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">LLM Model</label>
                          <select
                            v-model="editForm.llm_model"
                            class="form-select"
                          >
                            <option value="openai/gpt-4o-mini">
                              openai/gpt-4o-mini
                            </option>
                            <option value="openai/gpt-4o">openai/gpt-4o</option>
                            <option value="anthropic/claude-3-haiku">
                              anthropic/claude-3-haiku
                            </option>
                            <option value="google/gemini-flash-1.5">
                              google/gemini-flash-1.5
                            </option>
                            <option value="x-ai/grok-4-fast">
                              x-ai/grok-4-fast
                            </option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">STT Model</label>
                          <select
                            v-model="editForm.stt_model"
                            class="form-select"
                          >
                            <option value="nova-2-phonecall">
                              Deepgram Nova 2 Phonecall
                            </option>
                            <option value="nova-2-conversationalai">
                              Deepgram Nova 2 Conversational AI
                            </option>
                            <option value="nova-2-medical">
                              Deepgram Nova 2 Medical
                            </option>
                            <option value="nova-2-automotive">
                              Deepgram Nova 2 Automotive
                            </option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label class="form-label">TTS Model</label>
                          <select
                            v-model="editForm.tts_model"
                            class="form-select"
                          >
                            <option value="eleven_flash_v2_5">
                              ElevenLabs Flash v2.5
                            </option>
                            <option value="eleven_flash_v2">
                              ElevenLabs Flash v2
                            </option>
                            <option value="eleven_turbo_v2_5">
                              ElevenLabs Turbo v2.5
                            </option>
                            <option value="eleven_turbo_v2">
                              ElevenLabs Turbo v2
                            </option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">TTS Voice ID</label>

                          <div class="input-group">
                            <select
                              class="form-select"
                              style="max-width: 160px; border-right: none"
                              @change="editForm.tts_voice_id = $event.target.value"
                            >
                              <option value="" disabled selected>
                                Quick Fill...
                              </option>
                              <option
                                v-for="voice in voicePresets"
                                :key="voice.id"
                                :value="voice.id"
                              >
                                {{ voice.name }}
                              </option>
                            </select>

                            <input
                              v-model="editForm.tts_voice_id"
                              type="text"
                              class="form-control"
                              placeholder="Paste ID here or select preset..."
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div v-if="activeClientTab === 'prompting'">
                    <div class="mb-3">
                      <label class="form-label">Initial Greeting</label>
                      <textarea
                        v-model="editForm.initial_greeting"
                        class="form-control"
                        rows="2"
                      ></textarea>
                    </div>
                    <div class="mb-3">
                      <label
                        class="form-label d-flex justify-content-between align-items-center"
                      >
                        System Prompt
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary"
                          @click="toggleSystemPromptExpansion"
                        >
                          Expand to Full Screen
                        </button>
                      </label>
                      <textarea
                        v-model="editForm.system_prompt"
                        class="form-control"
                        rows="12"
                      ></textarea>
                    </div>
                  </div>

                  <div v-if="activeClientTab === 'tools'">
                    <div
                      class="p-4 border rounded"
                      style="
                        background: var(--theme-bg-dark);
                        border-color: var(--theme-bg-mid) !important;
                      "
                    >
                      <label
                        class="form-label mb-4 text-warning"
                        style="letter-spacing: 2px"
                        >>> ACTIVE CAPABILITIES</label
                      >

                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          v-model="editForm.enable_scheduling"
                          id="bundle_scheduling"
                        />
                        <label
                          class="form-check-label fw-bold"
                          for="bundle_scheduling"
                          >Enable Scheduling</label
                        >
                        <div class="text-muted small ms-4 mt-1">
                          Allows the agent to check availability, book,
                          reschedule, and cancel appointments via Google
                          Calendar.
                        </div>
                      </div>

                      <hr class="border-secondary opacity-25 my-3" />

                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          v-model="editForm.enable_memory"
                          id="bundle_contact"
                        />
                        <label
                          class="form-check-label fw-bold"
                          for="bundle_contact"
                          >Contact Memory</label
                        >
                        <div class="text-muted small ms-4 mt-1">
                          Allows the agent to learn and save the caller's name
                          for future personalized greetings.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- HISTORY MODAL -->
      <div
        class="modal fade"
        id="historyModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div
            class="modal-content"
            style="
              background: var(--theme-bg-dark);
              border: 1px solid var(--theme-blue);
              box-shadow: 0 0 20px rgba(125, 207, 255, 0.2);
            "
          >
            <div class="modal-header border-secondary border-opacity-25">
              <h5
                class="modal-title text-blue"
                style="
                  font-family: &quot;JetBrains Mono&quot;;
                  letter-spacing: 1px;
                "
              >
                <i class="bi bi-clock-history me-2"></i>TRANSACTION LOG
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body p-0">
              <div v-if="loadingHistory" class="p-5 text-center text-muted">
                <div class="spinner-border text-blue mb-2" role="status"></div>
                <div>Decrypting Ledger...</div>
              </div>
              <div v-else class="table-responsive" style="max-height: 500px">
                <table class="table table-custom table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th class="ps-3">Type</th>
                      <th>Time</th>
                      <th>Duration / STT</th>
                      <th>LLM (In/Out)</th>
                      <th>TTS</th>
                      <th>Conversation ID</th>
                      <th class="text-end">Cost</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="clientLedger.length === 0">
                      <td colspan="7" class="text-center py-4 text-muted">
                        No records found.
                      </td>
                    </tr>
                    <template
                      v-for="group in clientLedger"
                      :key="group.id || group.created_at"
                    >
                      <!-- MANUAL ENTRY -->
                      <tr v-if="group.type === 'MANUAL'">
                        <td class="ps-3">
                          <span
                            class="badge border"
                            :class="(group.metric_type || '').includes('CREDIT') ? 'border-success text-success' : ((group.metric_type || '').includes('DEBIT') ? 'border-danger text-danger' : 'border-secondary text-muted')"
                          >
                            {{ group.metric_type === 'MANUAL_CREDIT' ? 'CREDIT'
                            : (group.metric_type === 'MANUAL_DEBIT' ? 'DEBIT' :
                            group.metric_type) }}
                          </span>
                        </td>
                        <td class="text-info small font-monospace">
                          {{ formatDate(group.created_at) }}
                        </td>

                        <!-- Empty columns for metrics -->
                        <td></td>
                        <td></td>
                        <td></td>

                        <!-- Memo -->
                        <td class="text-muted small fst-italic">
                          Manual Adjustment
                        </td>

                        <!-- Total Amount -->
                        <td
                          class="font-monospace text-end"
                          :class="(group.metric_type || '').includes('CREDIT') ? 'text-success' : ((group.metric_type || '').includes('DEBIT') ? 'text-danger' : 'text-secondary')"
                        >
                          {{ (group.metric_type || '').includes('CREDIT') ? '+'
                          : '-' }}{{ formatQuantity(group) }}
                        </td>
                      </tr>

                      <!-- CONVERSATION GROUP -->
                      <tr v-else>
                        <td class="ps-3">
                          <span class="badge border border-purple text-purple"
                            >CALL</span
                          >
                        </td>
                        <td class="text-info small font-monospace">
                          {{ formatDate(group.created_at) }}
                        </td>

                        <!-- Duration -->
                        <td>
                          <div class="font-monospace">
                            {{ formatDuration(group.duration_sec) }}
                          </div>
                          <div class="small text-muted opacity-50">
                            ${{ group.duration_cost.toFixed(4) }}
                          </div>
                        </td>

                        <!-- LLM -->
                        <td>
                          <div class="font-monospace small">
                            <i class="bi bi-arrow-down-short text-success"></i
                            >{{ group.llm_input.toLocaleString() }}
                            <span class="text-muted">/</span>
                            <i class="bi bi-arrow-up-short text-info"></i>{{
                            group.llm_output.toLocaleString() }}
                          </div>
                          <div class="small text-muted opacity-50">
                            ${{ group.llm_cost.toFixed(4) }}
                          </div>
                        </td>

                        <!-- TTS -->
                        <td>
                          <div class="font-monospace">
                            {{ group.tts_chars.toLocaleString() }} ch
                          </div>
                          <div class="small text-muted opacity-50">
                            ${{ group.tts_cost.toFixed(4) }}
                          </div>
                        </td>

                        <!-- ID -->
                        <td>
                          <a
                            href="#"
                            @click.prevent="viewTranscript(group.id)"
                            class="text-info text-decoration-underline font-monospace small"
                          >
                            {{ truncateId(group.id) }}
                          </a>
                        </td>

                        <!-- Total -->
                        <td class="text-end">
                          <span
                            class="badge bg-dark border border-secondary text-muted"
                          >
                            -${{ group.total_cost.toFixed(4) }}
                          </span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRANSCRIPT MODAL -->
      <div
        class="modal fade"
        id="transcriptModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div
          class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
        >
          <div
            class="modal-content"
            style="
              background: var(--theme-bg-dark);
              border: 1px solid var(--theme-cyan);
              box-shadow: 0 0 20px rgba(125, 207, 255, 0.2);
            "
          >
            <div class="modal-header border-secondary border-opacity-25">
              <h5
                class="modal-title text-cyan"
                style="
                  font-family: &quot;JetBrains Mono&quot;;
                  letter-spacing: 1px;
                "
              >
                <i class="bi bi-chat-left-text me-2"></i>TRANSCRIPT DECRYPTED
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body bg-black p-0">
              <div v-if="loadingTranscript" class="p-5 text-center text-muted">
                <div class="spinner-border text-cyan mb-2" role="status"></div>
                <div>Fetching Audio Logs...</div>
              </div>
              <div v-else class="p-3 d-flex flex-column gap-3">
                <div
                  v-for="(msg, index) in selectedTranscript"
                  :key="index"
                  class="d-flex"
                  :class="msg.role === 'user' ? 'justify-content-end' : 'justify-content-start'"
                >
                  <div
                    class="p-3 rounded border position-relative"
                    style="max-width: 80%; min-width: 40%"
                    :class="msg.role === 'user' ? 'border-purple bg-dark bg-opacity-25' : 'border-blue bg-dark bg-opacity-10'"
                    :style="msg.role === 'user' ? 'border-left: 4px solid var(--theme-purple) !important;' : 'border-left: 4px solid var(--theme-blue) !important;'"
                  >
                    <div
                      class="small text-muted mb-1 font-monospace d-flex justify-content-between"
                    >
                      <span class="text-uppercase">{{ msg.role }}</span>
                      <span
                        >{{ new Date(msg.timestamp).toLocaleTimeString()
                        }}</span
                      >
                    </div>

                    <div class="text-white" style="white-space: pre-wrap">
                      {{ msg.content }}
                    </div>

                    <div
                      v-if="msg.tool_calls"
                      class="mt-2 pt-2 border-top border-secondary border-opacity-25"
                    >
                      <div class="small text-warning font-monospace mb-1">
                        <i class="bi bi-lightning-fill"></i> TOOL USE
                      </div>
                      <div
                        v-for="tool in msg.tool_calls"
                        :key="tool.id"
                        class="small text-muted font-monospace"
                      >
                        > {{ tool.function.name }}({{ tool.function.arguments
                        }})
                      </div>
                    </div>
                  </div>
                </div>
                <div
                  v-if="selectedTranscript.length === 0"
                  class="text-center text-muted py-5"
                >
                  No transcript data available for this session.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- SETTINGS MODAL -->
      <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="background: var(--theme-bg-dark); border: 1px solid var(--theme-bg-mid);">
            <div class="modal-header border-secondary border-opacity-25">
              <h5 class="modal-title text-muted" style="font-family: 'JetBrains Mono'; letter-spacing: 1px;">
                <i class="bi bi-gear me-2"></i>SETTINGS
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label text-muted small">THEME PRESET</label>
                <select v-model="currentTheme" @change="applyTheme(currentTheme)" class="form-select bg-dark text-white border-secondary" style="font-family: 'JetBrains Mono'">
                  <option v-for="theme in themes" :key="theme.key" :value="theme.key">
                    {{ theme.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./lib/js/vue.global.js"></script>
    <script src="./lib/js/axios.min.js"></script>
    <script>
      // Global logout function
      window.logout = function () {
        localStorage.removeItem("authToken");
        window.location.href = "/static/index.html";
      };

      const { createApp, ref, computed, onMounted, onUnmounted, nextTick } =
        Vue;

      createApp({
        setup() {
          const users = ref([]);
          const clients = ref([]);
          const ledger = ref([]);
          const activeCalls = ref([]);
          const total_usage_today = ref(0);
          const total_usage_month = ref(0);
          const selectedUser = ref(null);
          const selectedClient = ref(null);
          const showDebug = ref(false); // Default off for cleaner UI
          const userSearch = ref("");
          const token = localStorage.getItem("authToken");
          const isLoading = ref(true);

          // Theme State
          const themes = ref([]);
          const currentTheme = ref(localStorage.getItem("currentTheme") || "tokyo-night-default");
          const settingsModal = ref(null);

          const openSettings = () => {
             if (!settingsModal.value) {
                settingsModal.value = new bootstrap.Modal(document.getElementById("settingsModal"));
             }
             settingsModal.value.show();
          };

          const loadThemes = () => {
            const defaultThemes = [
              {
                key: "tokyo-night-default",
                name: "Tokyo Night Default",
                data: {
                  background: "#1a1b26",
                  foreground: "#c0caf5",
                  cursor: "#7aa2f7",
                  selection: "#283457",
                  ansi_colors: {
                    black: "#15161E",
                    red: "#F77693",
                    green: "#9ECE6A",
                    yellow: "#E0AF68",
                    blue: "#7AA2F7",
                    magenta: "#BB9AF7",
                    cyan: "#7DCFFF",
                    white: "#A9B1D6",
                    bright_black: "#414868",
                    bright_red: "#F77693",
                    bright_green: "#9ECE6A",
                    bright_yellow: "#E0AF68",
                    bright_blue: "#7AA2F7",
                    bright_magenta: "#BB9AF7",
                    bright_cyan: "#7DCFFF",
                    bright_white: "#C0CAF5",
                  },
                },
              },
              {
                key: "tokyo-night-day",
                name: "Tokyo Night Day",
                data: {
                  background: "#E2E2E7",
                  foreground: "#3760BF",
                  cursor: "#2E7DE9",
                  selection: "#B7C1E3",
                  ansi_colors: {
                    black: "#B3B5B9",
                    red: "#F52A65",
                    green: "#587539",
                    yellow: "#8C6C3E",
                    blue: "#2E7DE9",
                    magenta: "#9854F1",
                    cyan: "#007197",
                    white: "#6172B0",
                    bright_black: "#A1A6C5",
                    bright_red: "#F52A65",
                    bright_green: "#587539",
                    bright_yellow: "#8C6C3E",
                    bright_blue: "#2E7DE9",
                    bright_magenta: "#9854F1",
                    bright_cyan: "#007197",
                    bright_white: "#3760BF",
                  },
                },
              },
              {
                key: "iceberg-dark",
                name: "Iceberg Dark",
                data: {
                  background: "#161821",
                  foreground: "#C7C9D1",
                  cursor: "#89BFC3",
                  selection: "#272C41",
                  ansi_colors: {
                    black: "#1E212B",
                    red: "#E2777A",
                    green: "#B6BA89",
                    yellow: "#E2A677",
                    blue: "#83A5AD",
                    magenta: "#9F91A8",
                    cyan: "#89BFC3",
                    white: "#C7C9D1",
                    bright_black: "#6B7089",
                    bright_red: "#E98A8A",
                    bright_green: "#C0CAF5",
                    bright_yellow: "#E9B18A",
                    bright_blue: "#91A9C6",
                    bright_magenta: "#AD9FAD",
                    bright_cyan: "#95C4CC",
                    bright_white: "#D2D4DD",
                  },
                },
              },
              {
                key: "iceberg-light",
                name: "Iceberg Light",
                data: {
                  background: "#E8E9EC",
                  foreground: "#33374C",
                  cursor: "#3F83A6",
                  selection: "#CAD0D7",
                  ansi_colors: {
                    black: "#DCDFE7",
                    red: "#CC517A",
                    green: "#668E3D",
                    yellow: "#C57339",
                    blue: "#2D539E",
                    magenta: "#7759B5",
                    cyan: "#3F83A6",
                    white: "#33374C",
                    bright_black: "#838A96",
                    bright_red: "#CC3768",
                    bright_green: "#598030",
                    bright_yellow: "#B6662D",
                    bright_blue: "#22478E",
                    bright_magenta: "#6845AD",
                    bright_cyan: "#327698",
                    bright_white: "#3D425E",
                  },
                },
              },
            ];
            themes.value = defaultThemes;
            applyTheme(currentTheme.value);
          };

          const getBrightness = (hexColor) => {
             const color = hexColor.replace("#", "");
             const r = parseInt(color.substr(0, 2), 16);
             const g = parseInt(color.substr(2, 2), 16);
             const b = parseInt(color.substr(4, 2), 16);
             return (r * 299 + g * 587 + b * 114) / 1000;
          };

          const applyTheme = (themeKey) => {
            const theme = themes.value.find((t) => t.key === themeKey);
            if (!theme) return;
            const root = document.documentElement;
            const themeData = theme.data;
            root.style.setProperty("--theme-bg", themeData.background || "#1a1b26");
            root.style.setProperty("--theme-fg", themeData.foreground || "#c0caf5");
            root.style.setProperty("--theme-cursor", themeData.cursor || "#7aa2f7");
            root.style.setProperty("--theme-selection", themeData.selection || "#283457");

            const bgBrightness = getBrightness(themeData.background || "#1a1b26");
            const isLightTheme = bgBrightness > 128;
            const mutedColor = isLightTheme ? "#555" : "#888";
            root.style.setProperty("--theme-muted", mutedColor);

            const ansiColors = themeData.ansi_colors;
            if (ansiColors) {
               root.style.setProperty("--theme-bg-dark", ansiColors.black || "#16161e");
               root.style.setProperty("--theme-bg-mid", ansiColors.bright_black || "#2a2a37");
               root.style.setProperty("--theme-card-bg", ansiColors.black || "#16161e");
               root.style.setProperty("--theme-blue", ansiColors.blue || "#7dcfff");
               root.style.setProperty("--theme-purple", ansiColors.magenta || "#bb9af7");
               root.style.setProperty("--theme-green", ansiColors.green || "#9ece6a");
               root.style.setProperty("--theme-yellow", ansiColors.yellow || "#e0af68");
               root.style.setProperty("--theme-orange", ansiColors.yellow || "#e0af68");
               root.style.setProperty("--theme-red", ansiColors.red || "#f7768e");
               root.style.setProperty("--theme-cyan", ansiColors.cyan || "#7dcfff");
               root.style.setProperty("--theme-comment", ansiColors.bright_black || "#565f89");
               root.style.setProperty("--theme-logo-white", ansiColors.bright_white || "#ffffff");

               root.style.setProperty("--theme-black-bright", ansiColors.bright_black || "#414868");
               root.style.setProperty("--theme-red-bright", ansiColors.bright_red || "#f7768e");
               root.style.setProperty("--theme-green-bright", ansiColors.bright_green || "#9ece6a");
               root.style.setProperty("--theme-yellow-bright", ansiColors.bright_yellow || "#e0af68");
               root.style.setProperty("--theme-blue-bright", ansiColors.bright_blue || "#7aa2f7");
               root.style.setProperty("--theme-magenta-bright", ansiColors.bright_magenta || "#bb9af7");
               root.style.setProperty("--theme-cyan-bright", ansiColors.bright_cyan || "#7dcfff");
               root.style.setProperty("--theme-white-bright", ansiColors.bright_white || "#c0caf5");
            }

            root.style.setProperty("--theme-border-active", "2px");
            root.style.setProperty("--theme-tools-bg", "transparent");
            root.style.setProperty("--theme-tools-border", "var(--theme-bg-mid)");
            root.style.setProperty("--theme-tools-label", "var(--theme-purple)");

            if (isLightTheme) {
               root.style.setProperty("--theme-bg-dark", "#ffffff");
               root.style.setProperty("--theme-card-bg", "#ffffff");
               root.style.setProperty("--theme-bg-mid", "#b4b9c9");
               root.style.setProperty("--theme-table-stripe", "rgba(0, 0, 0, 0.03)");
               root.style.setProperty("--theme-table-hover", "rgba(46, 125, 233, 0.1)");
               root.style.setProperty("--theme-btn-glow", "rgba(0, 0, 0, 0.1)");
               root.style.setProperty("--theme-text-glow", "none");
               root.style.setProperty("--theme-gradient-1", "rgba(55, 96, 191, 0.15)");
               root.style.setProperty("--theme-gradient-2", "rgba(120, 117, 213, 0.15)");
               root.style.setProperty("--theme-border-active", "3px");
               root.style.setProperty("--theme-tools-bg", "rgba(158, 206, 106, 0.15)");
               root.style.setProperty("--theme-tools-border", "rgba(88, 117, 57, 0.5)");
               root.style.setProperty("--theme-tools-label", "#3c5220");
            } else {
               root.style.setProperty("--theme-gradient-1", "rgba(122, 162, 247, 0.08)");
               root.style.setProperty("--theme-gradient-2", "rgba(187, 154, 247, 0.08)");
            }

            currentTheme.value = themeKey;
            localStorage.setItem("currentTheme", themeKey);
          };

          const voicePresets = [
            {
              name: "Rachel (American, Calm, Pro)",
              id: "21m00Tcm4TlvDq8ikWAM",
            },
            { name: "Drew (American, News, Bold)", id: "29vD33N1CtxCmqQRPOHJ" },
            { name: "Clyde (Deep, Technical)", id: "2EiwWnXFnvU5JabPnv8n" },
            { name: "Mimi (Australian, Childish)", id: "zrHiDhphv9ZnVXBq79M6" },
            { name: "Fin (Irish, Energetic)", id: "D38z5RcWu1voky8WS1ja" },
            {
              name: "Antoni (American, Well-rounded)",
              id: "ErXwobaYiN019PkySvjV",
            },
            { name: "Thomas (American, Calm)", id: "GBv7mTt5Xyp17vW9q545" },
            {
              name: "Charlie (Australian, Casual)",
              id: "IKne3meq5aSn9XLyUdCD",
            },
            { name: "Emily (American, Calm)", id: "LcfcDJNUP1GQjkzn1xUU" },
            { name: "Elli (American, Emotional)", id: "MF3mGyEYCl7XYWbV9V6O" },
            { name: "Callum (American, Hoarse)", id: "N2lVS1w4Ejp13nTc3DX7" },
            { name: "Patrick (American, Shouty)", id: "ODq5zmih8GrVes37Dizd" },
            { name: "Harry (American, Anxiety)", id: "SOYHLrjzK2X1ezoPC6cr" },
            { name: "Liam (American, Neutral)", id: "TX3LPaxmHKxFdv7VOQHJ" },
            { name: "Dorothy (British, Pleasant)", id: "ThT5KcBeYPX3keUQqHPh" },
            { name: "Josh (American, Deep)", id: "TxGEqnHWrfWFTfGW9XjX" },
            { name: "Arnold (American, Nasal)", id: "VR6AewLTigWg4xSOukaG" },
            {
              name: "Charlotte (British, Seductive)",
              id: "XB0fDUnXU5powFXDhCwa",
            },
            { name: "Matilda (American, Warm)", id: "XrExE9yKIg1WjnnlVkGX" },
            { name: "James (Australian, Calm)", id: "ZQe5CZNOzWyzPSCn5a3c" },
            { name: "Joseph (British, News)", id: "Zlb1dXrM653N07WRdFW3" },
            { name: "Jeremy (American, Excited)", id: "bVMeCyTHy58xNoL34h3p" },
            { name: "Michael (American, Old)", id: "flq6f7yk4E4fJM5XTYuZ" },
            { name: "Ethan (American, Whisper)", id: "g5CIjZEefAph4nQFvHAz" },
            { name: "Gigi (American, Childish)", id: "jBpfuIE2acCO8z3wKNLl" },
            { name: "Freya (American, Overhyped)", id: "jsCqWAovK2LkecY7zXl4" },
            { name: "Santa Claus (Deep, Jolly)", id: "knrPHWnBmmDHMoiMeP3l" },
            { name: "Grace (American, Southern)", id: "oWAxZDx7w5VEj9dCyTzz" },
            { name: "Daniel (British, News)", id: "onwK4e9ZLuTAKqWW03F9" },
            { name: "Serena (American, Pleasant)", id: "pMsXgVXv3BLzUgSXRplE" },
            { name: "Adam (American, Deep)", id: "pNInz6obpgDQGcFmaJgB" },
            { name: "Nicole (American, Whisper)", id: "piTKgcLEGmPE4e6mEKli" },
            {
              name: "Bill (American, Trustworthy)",
              id: "pqHfZKP75CvOlQylNhV4",
            },
            { name: "Jessie (American, Raspy)", id: "t0jbNlBVZ17f02VDIeMI" },
            { name: "Sam (American, Raspy)", id: "yoZ06aMxZJJ28mfd3POQ" },
            { name: "Glinda (American, Witch)", id: "z9fAnlkpzviPz146aGWa" },
            { name: "Giovanni (Italian, Foreign)", id: "zcAOhNBS3c14rBihAFp1" },
            { name: "Domi (American, Strong)", id: "zRrTh6t1l6l36r8e9a2W" },
          ];

          // Ledger State
          const ledgerModal = ref(null);
          const isSubmitting = ref(false);
          const ledgerForm = ref({
            client_id: "",
            action: "credit",
            amount_minutes: 10,
            reason: "",
          });

          // Edit State
          const editClientModal = ref(null);
          const activeClientTab = ref("basic");
          const systemPromptExpanded = ref(false);

          const editForm = ref({
            id: "",
            name: "",
            cell: "",
            is_active: true,
            is_locked: false, // New Lock Field
            system_prompt: "",
            llm_model: "openai/gpt-4o-mini",
            stt_model: "nova-2-phonecall",
            tts_model: "eleven_flash_v2_5",
            tts_voice_id: "21m00Tcm4TlvDq8ikWAM",
            calendar_id: "",
            business_timezone: "America/Los_Angeles",
            business_start_hour: 9,
            business_end_hour: 17,
            initial_greeting: "",
            enable_scheduling: false,
            enable_memory: false,
          });

          // History State
          const historyModal = ref(null);
          const clientLedger = ref([]);
          const loadingHistory = ref(false);

          // Transcript State
          const transcriptModal = ref(null);
          const selectedTranscript = ref([]);
          const loadingTranscript = ref(false);



          const fetchData = async () => {
            if (!token) return (window.location.href = "/static/index.html");
            isLoading.value = true;
            try {
              const res = await axios.get("/api/admin/dashboard", {
                headers: { Authorization: `Bearer ${token}` },
              });
              console.log("God Mode Data:", res.data);
              users.value = res.data.users || [];
              clients.value = res.data.clients || [];
              ledger.value = res.data.ledger || [];
              total_usage_today.value = res.data.total_seconds_today || 0;
              total_usage_month.value = res.data.total_seconds_month || 0;
            } catch (e) {
              console.error(e);
              if (e.response && e.response.status === 403) {
                alert("UNAUTHORIZED ACCESS DETECTED. SYSTEM LOCKING.");
                window.location.href = "/static/index.html";
              }
            } finally {
              isLoading.value = false;
            }
          };

          // --- COMPUTED HELPERS ---

          const filteredUsers = computed(() => {
            if (!userSearch.value) return users.value;
            const q = userSearch.value.toLowerCase();

            return users.value.filter((u) => {
              // 1. User Identity Match
              if (u.email.toLowerCase().includes(q) || u.id.includes(q))
                return true;

              // 2. Deep Search: Check their clients
              // We find all clients owned by this user
              const userClients = clients.value.filter(
                (c) => c.owner_user_id === u.id,
              );

              // Check if ANY client matches name or cell
              return userClients.some(
                (c) =>
                  c.name.toLowerCase().includes(q) ||
                  (c.cell && c.cell.includes(q)),
              );
            });
          });

          const availableClients = computed(() => {
            if (!selectedUser.value) return [];
            return getUserClients(selectedUser.value.id);
          });

          const totalSystemBalance = computed(() => {
            return clients.value.reduce(
              (acc, client) => acc + (client.balance_seconds || 0),
              0,
            );
          });

          const orphanClients = computed(() => {
            const userIds = new Set(users.value.map((u) => u.id));
            return clients.value.filter((c) => !userIds.has(c.owner_user_id))
              .length;
          });

          // --- UTILITY METHODS ---

          const getClientCount = (uid) =>
            clients.value.filter((c) => c.owner_user_id === uid).length;
          const getUserClients = (uid) =>
            clients.value.filter((c) => c.owner_user_id === uid);

          const getUserTotalBalance = (uid) => {
            const userClients = getUserClients(uid);
            return userClients.reduce(
              (acc, c) => acc + (c.balance_seconds || 0),
              0,
            );
          };

          const getUserTotalUsage = (uid, field) => {
            const userClients = getUserClients(uid);
            return userClients.reduce(
              (acc, client) => acc + (client[field] || 0),
              0,
            );
          };

          const selectUser = (u) => {
            selectedUser.value = u;
            selectedClient.value = null; // Reset client selection
          };

          const selectClient = (c) => {
            selectedClient.value = c;
          };

          const formatDuration = (seconds) => {
            if (!seconds) return "0s";
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            if (m === 0) return `${s}s`;
            return `${m}m ${s}s`;
          };

          const formatQuantity = (entry) => {
            if (!entry || entry.quantity === undefined || entry.quantity === null)
              return "0";
            const type = entry.metric_type || "";
            const qty = entry.quantity;
            if (
              [
                "duration",
                "call_seconds",
                "MANUAL_CREDIT",
                "MANUAL_DEBIT",
              ].includes(type)
            ) {
              return formatDuration(qty);
            }
            return qty.toLocaleString();
          };

          const formatHour = (h) => {
            if (h === 0) return "12 AM";
            if (h === 12) return "12 PM";
            return h > 12 ? `${h - 12} PM` : `${h} AM`;
          };

          const formatDate = (dateString) => {
            if (!dateString) return "";
            return new Date(dateString).toLocaleString();
          };

          // --- EDIT METHODS ---

          const toggleSystemPromptExpansion = () => {
            systemPromptExpanded.value = !systemPromptExpanded.value;
          };

          const openEditModal = (client) => {
            const tools = client.enabled_tools || [];
            activeClientTab.value = "basic";
            systemPromptExpanded.value = false;

            editForm.value = {
              id: client.id,
              name: client.name,
              cell: client.cell || "",
              is_active: client.is_active !== false,
              is_locked: tools.includes("ADMIN_LOCKED"), // Set Lock State
              system_prompt: client.system_prompt || "",
              llm_model: client.llm_model || "openai/gpt-4o-mini",
              stt_model: client.stt_model || "nova-2-phonecall",
              tts_model: client.tts_model || "eleven_flash_v2_5",
              tts_voice_id: client.tts_voice_id || "21m00Tcm4TlvDq8ikWAM",
              calendar_id: client.calendar_id || "",
              business_timezone:
                client.business_timezone || "America/Los_Angeles",
              business_start_hour: client.business_start_hour ?? 9,
              business_end_hour: client.business_end_hour ?? 17,
              initial_greeting: client.initial_greeting || "",
              enable_scheduling: tools.includes("book_appointment"),
              enable_memory: tools.includes("save_contact_name"),
            };

            if (!editClientModal.value) {
              editClientModal.value = new bootstrap.Modal(
                document.getElementById("editClientModal"),
              );
            }
            editClientModal.value.show();
          };

          const submitEditClient = async () => {
            isSubmitting.value = true;
            try {
              // Construct Enabled Tools
              const tools = [];
              if (editForm.value.enable_scheduling) {
                tools.push(
                  "get_available_slots",
                  "book_appointment",
                  "reschedule_appointment",
                  "list_my_appointments",
                  "cancel_appointment",
                );
              }
              if (editForm.value.enable_memory) {
                tools.push("save_contact_name");
              }
              // Admin Lock Tool
              if (editForm.value.is_locked) {
                tools.push("ADMIN_LOCKED");
              }

              const payload = {
                name: editForm.value.name,
                cell: editForm.value.cell,
                is_active: editForm.value.is_active,
                system_prompt: editForm.value.system_prompt,
                llm_model: editForm.value.llm_model,
                stt_model: editForm.value.stt_model,
                tts_model: editForm.value.tts_model,
                tts_voice_id: editForm.value.tts_voice_id,
                calendar_id: editForm.value.calendar_id,
                business_timezone: editForm.value.business_timezone,
                business_start_hour: editForm.value.business_start_hour,
                business_end_hour: editForm.value.business_end_hour,
                initial_greeting: editForm.value.initial_greeting,
                enabled_tools: tools,
              };

              await axios.put(
                `/api/admin/client/${editForm.value.id}`,
                payload,
                {
                  headers: { Authorization: `Bearer ${token}` },
                },
              );

              alert("Configuration Updated Successfully.");
              editClientModal.value.hide();
              await fetchData(); // Refresh
            } catch (e) {
              console.error("Edit failed:", e);
              alert(
                "Update Failed: " + (e.response?.data?.detail || e.message),
              );
            } finally {
              isSubmitting.value = false;
            }
          };

          const toggleClientStatus = async (client) => {
             if (!confirm(`Are you sure you want to ${client.is_active ? 'DISABLE' : 'ENABLE'} this client?`)) return;
             try {
                // If enabling, we need to make sure we don't accidentally remove the lock if it exists
                // But for a simple toggle, we just send is_active. 
                // The backend handles the lock check on enabling.
                
                await axios.put(`/api/admin/client/${client.id}`, { is_active: !client.is_active }, {
                   headers: { Authorization: `Bearer ${token}` }
                });
                
                // Refresh data to reflect changes
                await fetchData();
                
                // Re-select the client to keep the view updated
                if (selectedClient.value && selectedClient.value.id === client.id) {
                   const updatedClient = clients.value.find(c => c.id === client.id);
                   if (updatedClient) selectedClient.value = updatedClient;
                }
             } catch (e) {
                alert("Failed to toggle status: " + (e.response?.data?.detail || e.message));
             }
          };

          // --- LEDGER METHODS ---

          const openLedgerModal = () => {
            if (!selectedUser.value) return;

            const userClients = getUserClients(selectedUser.value.id);
            if (userClients.length > 0) {
              ledgerForm.value.client_id = userClients[0].id;
            }
            ledgerForm.value.action = "credit";
            ledgerForm.value.amount_minutes = 60;
            ledgerForm.value.reason = "";

            if (!ledgerModal.value) {
              ledgerModal.value = new bootstrap.Modal(
                document.getElementById("ledgerModal"),
              );
            }
            ledgerModal.value.show();
          };

          const submitLedger = async () => {
            isSubmitting.value = true;
            try {
              let seconds = ledgerForm.value.amount_minutes * 60;
              if (ledgerForm.value.action === "debit") {
                seconds = -seconds;
              }

              const revenue_usd =
                parseFloat(ledgerForm.value.revenue_usd || "0") || 0;
              await axios.post(
                "/api/admin/adjust-balance",
                {
                  client_id: ledgerForm.value.client_id,
                  amount_seconds: seconds,
                  reason: ledgerForm.value.reason,
                  revenue_usd: revenue_usd,
                },
                {
                  headers: { Authorization: `Bearer ${token}` },
                },
              );

              alert("Transaction Processed Successfully.");
              ledgerModal.value.hide();
              await fetchData(); // Refresh data
            } catch (e) {
              console.error("Ledger Error:", e);
              alert(
                "Transaction Failed: " +
                  (e.response?.data?.detail || e.message),
              );
            } finally {
              isSubmitting.value = false;
            }
          };

          // --- HISTORY METHODS ---

          const groupTransactions = (rawLedger) => {
            const groups = {};
            const result = [];

            rawLedger.forEach((entry) => {
              if (entry.conversation_id) {
                if (!groups[entry.conversation_id]) {
                  groups[entry.conversation_id] = {
                    type: "CONVERSATION",
                    id: entry.conversation_id,
                    created_at: entry.created_at,
                    total_cost: 0,
                    duration_sec: 0,
                    duration_cost: 0,
                    llm_input: 0,
                    llm_output: 0,
                    llm_cost: 0,
                    tts_chars: 0,
                    tts_cost: 0,
                    items: [],
                  };
                  result.push(groups[entry.conversation_id]);
                }
                const group = groups[entry.conversation_id];
                group.items.push(entry);
                const cost = entry.cost_usd || 0;
                group.total_cost += cost;

                const mType = entry.metric_type;
                const qty = entry.quantity || 0;

                if (mType === "duration" || mType === "call_seconds") {
                  group.duration_sec += qty;
                  group.duration_cost += cost;
                } else if (mType === "llm_tokens_input") {
                  group.llm_input += qty;
                  group.llm_cost += cost;
                } else if (mType === "llm_tokens_output") {
                  group.llm_output += qty;
                  group.llm_cost += cost;
                } else if (mType === "tts_characters") {
                  group.tts_chars += qty;
                  group.tts_cost += cost;
                }
              } else {
                result.push({
                  type: "MANUAL",
                  ...entry,
                });
              }
            });

            return result.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at),
            );
          };

          const openHistoryModal = async (client) => {
            if (!historyModal.value) {
              historyModal.value = new bootstrap.Modal(
                document.getElementById("historyModal"),
              );
            }
            historyModal.value.show();
            loadingHistory.value = true;
            clientLedger.value = [];

            try {
              const res = await axios.get(
                `/api/admin/client/${client.id}/ledger?_=${new Date().getTime()}`,
                {
                  headers: { Authorization: `Bearer ${token}` },
                },
              );
              clientLedger.value = groupTransactions(res.data.ledger);
            } catch (e) {
              console.error("History fetch failed:", e);
              alert("Failed to fetch history.");
            } finally {
              loadingHistory.value = false;
            }
          };

          const viewTranscript = async (convId) => {
            historyModal.value.hide();
            if (!transcriptModal.value) {
              transcriptModal.value = new bootstrap.Modal(
                document.getElementById("transcriptModal"),
              );
            }
            transcriptModal.value.show();
            loadingTranscript.value = true;
            selectedTranscript.value = [];

            try {
              const res = await axios.get(`/api/admin/conversation/${convId}`, {
                headers: { Authorization: `Bearer ${token}` },
              });
              // The API returns the conversation object, transcript is a property
              selectedTranscript.value = res.data.transcript || [];
            } catch (e) {
              console.error("Transcript fetch failed:", e);
              alert("Failed to fetch transcript.");
            } finally {
              loadingTranscript.value = false;
            }
          };

          // --- USER ACTIONS ---

          const toggleUserStatus = async (user) => {
            const action = user.is_active ? "BAN" : "ENABLE";
            if (!confirm(`Are you sure you want to ${action} this user?`))
              return;

            try {
              const res = await axios.post(
                `/api/admin/user/${user.id}/toggle-status`,
                {},
                {
                  headers: { Authorization: `Bearer ${token}` },
                },
              );

              // Optimistic update
              user.is_active = res.data.is_active;

              // Refresh data to reflect cascaded client status changes
              await fetchData();
            } catch (e) {
              console.error("Status toggle failed:", e);
              alert("Failed to update user status.");
            }
          };

          // --- LIVE MONITORING ---
          const calculateDuration = (startTime) => {
            if (!startTime) return 0;
            const start = new Date(startTime).getTime();
            const now = new Date().getTime();
            return Math.floor((now - start) / 1000);
          };

          const truncateId = (id) => {
            if (!id) return "UNKNOWN";
            return id.substring(0, 8);
          };

          const pollActiveCalls = async () => {
            if (!token) return;
            try {
              const res = await axios.get("/api/admin/active-calls", {
                headers: { Authorization: `Bearer ${token}` },
              });
              activeCalls.value = res.data;
            } catch (e) {
              console.error("Poll failed", e);
            }
          };

          const pollInterval = setInterval(pollActiveCalls, 3000);
          const tickInterval = setInterval(() => triggerRef(activeCalls), 1000);

          onUnmounted(() => {
            clearInterval(pollInterval);
            clearInterval(tickInterval);
          });

          onMounted(() => {
            loadThemes();
            fetchData();
            pollActiveCalls();
            // Update durations locally every second to keep UI smooth
            setInterval(() => {
              // Force reactivity update if needed, though the template uses calculateDuration() directly on render.
              // Vue's reactivity system handles the time diff if we used a ref for "now", but calling method in template works too.
              // To be safe and performant, we usually update a "now" ref, but this is simple enough.
              triggerRef(activeCalls);
            }, 1000);
          });

          const triggerRef = (ref) => {
            ref.value = [...ref.value];
          };

          return {
            users,
            clients,
            selectedUser,
            isLoading,
            themes,
            currentTheme,
            applyTheme,
            openSettings,
            showDebug,
            userSearch,
            filteredUsers,
            totalSystemBalance,
            orphanClients,
            fetchData,
            selectUser,
            getClientCount,
            getUserClients,
            getUserTotalBalance,
            getUserTotalUsage,
            formatDuration,
            formatQuantity,
            formatDate,

            // Ledger
            ledgerForm,
            availableClients,
            openLedgerModal,
            submitLedger,
            isSubmitting,
            // Edit
            editForm,
            openEditModal,
            submitEditClient,
            activeClientTab,
            systemPromptExpanded,
            toggleSystemPromptExpansion,
            formatHour,
            // History
            openHistoryModal,
            clientLedger,
            loadingHistory,
            viewTranscript,
            // Transcript
            transcriptModal,
            selectedTranscript,
            loadingTranscript,
            // Actions
            toggleUserStatus,
            // Live
            activeCalls,
            calculateDuration,
            truncateId,
            // Const
            voicePresets,
            total_usage_today,
            total_usage_month,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
